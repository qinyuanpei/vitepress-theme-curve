{{ define "main" }}
{{ if gt (len (findRE "<h[1-4]" .Content)) 0 }}
{{ .Scratch.Set "hasTOC" true }}
{{ end }}
<div class="post">
    <div class="post-meta">
        <div class="meta">
            <!-- 分类 -->
            <div class="categories">
                {{ with .Params.categories }}
                {{ range . }}
                <a href="/categories/{{ . | urlize }}" class="cat-item">
                    <i class="iconfont icon-folder"></i>
                    <span class="name">{{ . }}</span>
                </a>
                {{ end }}
                {{ end }}
            </div>
            <!-- 标签 -->
            <div class="tags">
                {{ with .Params.tags }}
                {{ range . }}
                <a href="/tags/{{ . | urlize }}" class="tag-item">
                    <i class="iconfont icon-hashtag"></i>
                    <span class="name">{{ . }}</span>
                </a>
                {{ end }}
                {{ end }}
            </div>
        </div>
        <h1 class="title">
            {{ .Title | default "未命名文章" }}
        </h1>
        <div class="other-meta">
            <!-- 发布日期 -->
            <span class="meta date">
                <i class="iconfont icon-date"></i>
                {{ .Date.Format "2006-01-02" }}
            </span>
            <!-- 更新日期 -->
            <span class="update meta">
                <i class="iconfont icon-time"></i>
                {{ .Lastmod.Format "2006-01-02" }}
            </span>
            <!-- 热度 -->
            <span class="hot meta">
                <i class="iconfont icon-fire"></i>
                <span id="twikoo_visitors" class="artalk-pv-count">0</span>
            </span>
            <!-- 评论数 -->
            <span class="chat meta hover" data-scroll-to="comments">
                <i class="iconfont icon-chat"></i>
                <span id="twikoo_comments" class="artalk-comment-count">0</span>
            </span>
        </div>
    </div>
    <div class="post-content">
        <article class="post-article s-card">
            <!-- 过期提醒 -->
            {{ $days := div (sub now.Unix .Date.Unix) 86400 }}
            {{ if ge $days 180 }}
            <div class="expired s-card">
                本文发表于 <strong>{{ $days }}</strong> 天前，其中的信息可能已经事过境迁
            </div>
            {{ end }}

            {{ partial "components/post/article-gpt.html" . }}

            <!-- 文章内容 -->
            <div id="page-content" class="markdown-main-style">
                {{ .Content }}
            </div>

            <!-- 版权信息 -->
            {{ if ne .Params.copyright false }}
            {{ partial "components/post/copyright.html" . }}
            {{ end }}

            <!-- 其他信息 -->
            <div class="other-meta">
                <div class="all-tags">
                    {{ with .Params.tags }}
                    {{ range . }}
                    <a href="/tags/{{ . | urlize }}" class="tag-item">
                        <i class="iconfont icon-hashtag"></i>
                        <span class="name">{{ . }}</span>
                    </a>
                    {{ end }}
                    {{ end }}
                </div>
                <a href="https://eqnxweimkr5.feishu.cn/share/base/form/shrcnCXCPmxCKKJYI3RKUfefJre" 
                   class="report" 
                   target="_blank">
                    <i class="iconfont icon-report"></i>
                    反馈与投诉
                </a>
            </div>

            <!-- 打赏按钮 -->
            {{ partial "components/post/reward.html" . }}

            <!-- 上一篇/下一篇 -->
            {{ partial "components/next-post.html" . }}

            <!-- 相关文章 -->
            {{ partial "components/post/related-post.html" . }}

            <!-- 评论 -->
            <div id="comments">
                {{ partial "components/comments/include.html" . }}
            </div>
        </article>
        <!-- 侧边栏 -->
        {{ partial "components/aside.html" (dict "context" . "showToc" true) }}
    </div>
</div>

<style>
/* 基础变量 */
:root {
  --code-bg: #fff;
  --code-border: #e1e4e8;
  --code-line-number-color: #8b949e;
  --code-line-number-border: #e1e4e8;
  --code-header-bg: #f6f8fa;
  --code-header-color: #424242;
  --code-button-hover: #f3f4f6;
}

/* 暗色模式变量 */
@media (prefers-color-scheme: dark) {
  :root {
    --code-bg: #0d1117;
    --code-border: #30363d;
    --code-line-number-color: #8b949e;
    --code-line-number-border: #30363d;
    --code-header-bg: #161b22;
    --code-header-color: #c9d1d9;
    --code-button-hover: #21262d;
  }
}

.highlight {
  position: relative;
  background: var(--code-bg);
  border: 1px solid var(--code-border);
  border-radius: 6px;
}

/* 代码头部区域 */
.highlight-header {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2.2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--code-header-bg);
  border-bottom: 1px solid var(--code-border);
  border-radius: 6px 6px 0 0;
  padding: 0 0.5rem;
}

/* 左侧信息区域 */
.highlight-info {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding-left: 0.5rem;
  color: var(--code-header-color);
  font-size: 0.75rem;
}

/* 语言标签 */
.highlight-lang {
  padding: 0.2rem 0.5rem;
  border-radius: 3px;
  background: var(--code-bg);
  color: var(--code-header-color);
}

/* 复制按钮 */
.copy-button {
  padding: 0.2rem 0.8rem;
  font-size: 0.75rem;
  color: var(--code-header-color);
  background: var(--code-bg);
  border: 1px solid var(--code-border);
  border-radius: 3px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.copy-button:hover {
  background: var(--code-button-hover);
}

.copy-button.copied {
  color: #1a7f37;
  border-color: #1a7f37;
}

@media (prefers-color-scheme: dark) {
  .copy-button.copied {
    color: #7ee787;
    border-color: #7ee787;
  }
}

/* 代码区域 */
.highlight-content {
  display: flex;
  width: 100%;
  margin-top: 2.2rem; /* 为头部留出空间 */
}

/* 行号 */
.line-numbers {
  padding: 1rem 0;
  min-width: 3.5em;
  text-align: right;
  color: var(--code-line-number-color);
  border-right: 1px solid var(--code-line-number-border);
  user-select: none;
  background: var(--code-header-bg);
}

.line-numbers span {
  display: block;
  padding-right: 1rem;
  line-height: 1.5;
  font-size: 0.875rem;
  font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
}

/* 代码主体 */
.highlight pre {
  flex: 1;
  margin: 0;
  padding: 1rem 0;
  overflow-x: auto;
  background-color: var(--code-bg);;
}

.highlight pre code {
  padding: 0 1rem;
  display: block;
  font-size: 0.875rem;
  line-height: 1.5;
  font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
}

/* 滚动条美化 */
.highlight pre::-webkit-scrollbar {
  height: 8px;
}

.highlight pre::-webkit-scrollbar-thumb {
  background: var(--code-border);
  border-radius: 4px;
}

.highlight pre::-webkit-scrollbar-track {
  background: var(--code-header-bg);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // 初始化 highlight.js
  hljs.highlightAll();

  document.querySelectorAll('pre > code').forEach((codeBlock) => {
    const pre = codeBlock.parentElement;
    const container = document.createElement('div');
    container.className = 'highlight';
    pre.parentNode.insertBefore(container, pre);

    // 获取语言
    const language = codeBlock.getAttribute('data-lang') || codeBlock.className.match(/language-(\w+)/)?.[1] || 'plaintext';

    // 创建头部
    const header = document.createElement('div');
    header.className = 'highlight-header';
    
    // 创建左侧信息区域
    const info = document.createElement('div');
    info.className = 'highlight-info';
    
    // 添加语言标签
    const lang = document.createElement('span');
    lang.className = 'highlight-lang';
    lang.textContent = language;
    info.appendChild(lang);
    
    // 添加行数信息
    const lines = codeBlock.innerHTML.trim().split('\n');
    const lineCount = document.createElement('span');
    lineCount.textContent = `${lines.length} 行`;
    lineCount.style.display = 'none';
    info.appendChild(lineCount);
    
    header.appendChild(info);

    // 添加复制按钮
    const copyButton = document.createElement('button');
    copyButton.className = 'copy-button';
    copyButton.textContent = '复制';
    header.appendChild(copyButton);

    // 创建内容区域
    const content = document.createElement('div');
    content.className = 'highlight-content';

    // 添加行号
    const lineNumbers = document.createElement('div');
    lineNumbers.className = 'line-numbers';
    lineNumbers.innerHTML = lines.map((_, i) => `<span>${i + 1}</span>`).join('');

    content.appendChild(lineNumbers);
    content.appendChild(pre);

    container.appendChild(header);
    container.appendChild(content);

    // 复制功能
    copyButton.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(codeBlock.textContent);
        copyButton.textContent = '已复制';
        copyButton.classList.add('copied');
        setTimeout(() => {
          copyButton.textContent = '复制';
          copyButton.classList.remove('copied');
        }, 2000);
      } catch (err) {
        console.error('复制失败:', err);
        copyButton.textContent = '复制失败';
      }
    });
  });
});
</script>
{{ end }} 