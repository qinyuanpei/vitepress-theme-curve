<!DOCTYPE html>
<html lang="zh-cn"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    
    <title>一道 HashSet 面试题引发的蝴蝶效应 - 元视角</title>
    <meta name="description" content="在这篇文章中，作者通过解读 HashSet 的源代码，介绍了 HashSet 去重的原理以及与 IEqualityComparer&lt;T&gt; 接口的关系。进一步讨论了在排序和去重操作中的接口应用，包括 IEquatable&lt;T&gt;、IComparable/IComparable&lt;T&gt; 和 IComparer&lt;T&gt; 接口的作用。通过对 HashSet、Dictionary 和去重操作的探讨，展示了这些数据结构和接口之间的联系，强调了在处理排序和去重时的重要性。整体上，文章通过解答一个关于 HashSet 的面试问题，深入探讨了涉及数据结构和接口的相关知识点，展示了技术知识体系中的连锁效应。">
    
    
    <link rel="shortcut icon" href="" type="image/x-icon">

    
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">

    
    <link rel="icon" type="image/png" href="/images/favicon.png">
    
    
    <meta property="og:title" content="一道 HashSet 面试题引发的蝴蝶效应">
    <meta property="og:description" content="在这篇文章中，作者通过解读 HashSet 的源代码，介绍了 HashSet 去重的原理以及与 IEqualityComparer&lt;T&gt; 接口的关系。进一步讨论了在排序和去重操作中的接口应用，包括 IEquatable&lt;T&gt;、IComparable/IComparable&lt;T&gt; 和 IComparer&lt;T&gt; 接口的作用。通过对 HashSet、Dictionary 和去重操作的探讨，展示了这些数据结构和接口之间的联系，强调了在处理排序和去重时的重要性。整体上，文章通过解答一个关于 HashSet 的面试问题，深入探讨了涉及数据结构和接口的相关知识点，展示了技术知识体系中的连锁效应。">
    <meta property="og:type" content="article">
    <meta property="og:url" content="http://localhost:1313/posts/3411909634/">
    
    
    <link rel="stylesheet" href="/css/style.css">
    
    
    <link rel="stylesheet" href="/scss/main.min.c449e5d261bc767af57e92a0d674c4bc083dfd9e46355f92e505475ee926aae0.css">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_3159629_2j0vwz8wd1k.css">
    
    
    <script src="/js/banner.js" defer></script>
    
    
    
    

    <link crossorigin="" rel="preconnect" href="https://s1.hdslb.com">
    <link crossorigin="" rel="preconnect" href="https://mirrors.sustech.edu.cn">
    <link crossorigin="anonymous" rel="stylesheet" href="https://s1.hdslb.com/bfs/static/jinkela/long/font/regular.css">
    <link crossorigin="anonymous" rel="stylesheet" href="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/lxgw-wenkai-screen-webfont/1.7.0/style.css">
    <link crossorigin="anonymous" rel="stylesheet" href="https://cdn2.codesign.qq.com/icons/g5ZpEgx3z4VO6j2/latest/iconfont.css">
    <link rel="preconnect" href="https://use.sevencdn.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link crossorigin="anonymous" href="https://use.sevencdn.com/css2?family=Fira+Code:wght@300..700&amp;display=swap" rel="stylesheet">
    <link href="https://X5EBEZB53I-dsn.algolia.net" rel="preconnect" crossorigin="">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" media="(prefers-color-scheme: dark)">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" media="(prefers-color-scheme: light)">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css" />
    <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js"></script>
</head> <body><div class="background patterns">
    
    <div class="bg-mask"></div>
    
    
    <div class="bg-image" style="background-image: url('https://tuapi.eees.cc/api.php?category=%7bdongman,fengjing%7d&amp;type=302')"></div>
    
    
    
</div> 

<style>
    .background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: -2;
      &.patterns {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='192' height='192' viewBox='0 0 192 192'%3E%3Cpath fill='%23494849' fill-opacity='0.08' d='M192 15v2a11 11 0 0 0-11 11c0 1.94 1.16 4.75 2.53 6.11l2.36 2.36a6.93 6.93 0 0 1 1.22 7.56l-.43.84a8.08 8.08 0 0 1-6.66 4.13H145v35.02a6.1 6.1 0 0 0 3.03 4.87l.84.43c1.58.79 4 .4 5.24-.85l2.36-2.36a12.04 12.04 0 0 1 7.51-3.11 13 13 0 1 1 .02 26 12 12 0 0 1-7.53-3.11l-2.36-2.36a4.93 4.93 0 0 0-5.24-.85l-.84.43a6.1 6.1 0 0 0-3.03 4.87V143h35.02a8.08 8.08 0 0 1 6.66 4.13l.43.84a6.91 6.91 0 0 1-1.22 7.56l-2.36 2.36A10.06 10.06 0 0 0 181 164a11 11 0 0 0 11 11v2a13 13 0 0 1-13-13 12 12 0 0 1 3.11-7.53l2.36-2.36a4.93 4.93 0 0 0 .85-5.24l-.43-.84a6.1 6.1 0 0 0-4.87-3.03H145v35.02a8.08 8.08 0 0 1-4.13 6.66l-.84.43a6.91 6.91 0 0 1-7.56-1.22l-2.36-2.36A10.06 10.06 0 0 0 124 181a11 11 0 0 0-11 11h-2a13 13 0 0 1 13-13c2.47 0 5.79 1.37 7.53 3.11l2.36 2.36a4.94 4.94 0 0 0 5.24.85l.84-.43a6.1 6.1 0 0 0 3.03-4.87V145h-35.02a8.08 8.08 0 0 1-6.66-4.13l-.43-.84a6.91 6.91 0 0 1 1.22-7.56l2.36-2.36A10.06 10.06 0 0 0 107 124a11 11 0 0 0-22 0c0 1.94 1.16 4.75 2.53 6.11l2.36 2.36a6.93 6.93 0 0 1 1.22 7.56l-.43.84a8.08 8.08 0 0 1-6.66 4.13H49v35.02a6.1 6.1 0 0 0 3.03 4.87l.84.43c1.58.79 4 .4 5.24-.85l2.36-2.36a12.04 12.04 0 0 1 7.51-3.11A13 13 0 0 1 81 192h-2a11 11 0 0 0-11-11c-1.94 0-4.75 1.16-6.11 2.53l-2.36 2.36a6.93 6.93 0 0 1-7.56 1.22l-.84-.43a8.08 8.08 0 0 1-4.13-6.66V145H11.98a6.1 6.1 0 0 0-4.87 3.03l-.43.84c-.79 1.58-.4 4 .85 5.24l2.36 2.36a12.04 12.04 0 0 1 3.11 7.51A13 13 0 0 1 0 177v-2a11 11 0 0 0 11-11c0-1.94-1.16-4.75-2.53-6.11l-2.36-2.36a6.93 6.93 0 0 1-1.22-7.56l.43-.84a8.08 8.08 0 0 1 6.66-4.13H47v-35.02a6.1 6.1 0 0 0-3.03-4.87l-.84-.43c-1.59-.8-4-.4-5.24.85l-2.36 2.36A12 12 0 0 1 28 109a13 13 0 1 1 0-26c2.47 0 5.79 1.37 7.53 3.11l2.36 2.36a4.94 4.94 0 0 0 5.24.85l.84-.43A6.1 6.1 0 0 0 47 84.02V49H11.98a8.08 8.08 0 0 1-6.66-4.13l-.43-.84a6.91 6.91 0 0 1 1.22-7.56l2.36-2.36A10.06 10.06 0 0 0 11 28 11 11 0 0 0 0 17v-2a13 13 0 0 1 13 13c0 2.47-1.37 5.79-3.11 7.53l-2.36 2.36a4.94 4.94 0 0 0-.85 5.24l.43.84A6.1 6.1 0 0 0 11.98 47H47V11.98a8.08 8.08 0 0 1 4.13-6.66l.84-.43a6.91 6.91 0 0 1 7.56 1.22l2.36 2.36A10.06 10.06 0 0 0 68 11 11 11 0 0 0 79 0h2a13 13 0 0 1-13 13 12 12 0 0 1-7.53-3.11l-2.36-2.36a4.93 4.93 0 0 0-5.24-.85l-.84.43A6.1 6.1 0 0 0 49 11.98V47h35.02a8.08 8.08 0 0 1 6.66 4.13l.43.84a6.91 6.91 0 0 1-1.22 7.56l-2.36 2.36A10.06 10.06 0 0 0 85 68a11 11 0 0 0 22 0c0-1.94-1.16-4.75-2.53-6.11l-2.36-2.36a6.93 6.93 0 0 1-1.22-7.56l.43-.84a8.08 8.08 0 0 1 6.66-4.13H143V11.98a6.1 6.1 0 0 0-3.03-4.87l-.84-.43c-1.59-.8-4-.4-5.24.85l-2.36 2.36A12 12 0 0 1 124 13a13 13 0 0 1-13-13h2a11 11 0 0 0 11 11c1.94 0 4.75-1.16 6.11-2.53l2.36-2.36a6.93 6.93 0 0 1 7.56-1.22l.84.43a8.08 8.08 0 0 1 4.13 6.66V47h35.02a6.1 6.1 0 0 0 4.87-3.03l.43-.84c.8-1.59.4-4-.85-5.24l-2.36-2.36A12 12 0 0 1 179 28a13 13 0 0 1 13-13zM84.02 143a6.1 6.1 0 0 0 4.87-3.03l.43-.84c.8-1.59.4-4-.85-5.24l-2.36-2.36A12 12 0 0 1 83 124a13 13 0 1 1 26 0c0 2.47-1.37 5.79-3.11 7.53l-2.36 2.36a4.94 4.94 0 0 0-.85 5.24l.43.84a6.1 6.1 0 0 0 4.87 3.03H143v-35.02a8.08 8.08 0 0 1 4.13-6.66l.84-.43a6.91 6.91 0 0 1 7.56 1.22l2.36 2.36A10.06 10.06 0 0 0 164 107a11 11 0 0 0 0-22c-1.94 0-4.75 1.16-6.11 2.53l-2.36 2.36a6.93 6.93 0 0 1-7.56 1.22l-.84-.43a8.08 8.08 0 0 1-4.13-6.66V49h-35.02a6.1 6.1 0 0 0-4.87 3.03l-.43.84c-.79 1.58-.4 4 .85 5.24l2.36 2.36a12.04 12.04 0 0 1 3.11 7.51A13 13 0 1 1 83 68a12 12 0 0 1 3.11-7.53l2.36-2.36a4.93 4.93 0 0 0 .85-5.24l-.43-.84A6.1 6.1 0 0 0 84.02 49H49v35.02a8.08 8.08 0 0 1-4.13 6.66l-.84.43a6.91 6.91 0 0 1-7.56-1.22l-2.36-2.36A10.06 10.06 0 0 0 28 85a11 11 0 0 0 0 22c1.94 0 4.75-1.16 6.11-2.53l2.36-2.36a6.93 6.93 0 0 1 7.56-1.22l.84.43a8.08 8.08 0 0 1 4.13 6.66V143h35.02z'%3E%3C/path%3E%3C/svg%3E");
      }
      &.dark {
        &.patterns {
          background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='192' height='192' viewBox='0 0 192 192'%3E%3Cpath fill='%23fcfcfc' fill-opacity='0.08' d='M192 15v2a11 11 0 0 0-11 11c0 1.94 1.16 4.75 2.53 6.11l2.36 2.36a6.93 6.93 0 0 1 1.22 7.56l-.43.84a8.08 8.08 0 0 1-6.66 4.13H145v35.02a6.1 6.1 0 0 0 3.03 4.87l.84.43c1.58.79 4 .4 5.24-.85l2.36-2.36a12.04 12.04 0 0 1 7.51-3.11 13 13 0 1 1 .02 26 12 12 0 0 1-7.53-3.11l-2.36-2.36a4.93 4.93 0 0 0-5.24-.85l-.84.43a6.1 6.1 0 0 0-3.03 4.87V143h35.02a8.08 8.08 0 0 1 6.66 4.13l.43.84a6.91 6.91 0 0 1-1.22 7.56l-2.36 2.36A10.06 10.06 0 0 0 181 164a11 11 0 0 0 11 11v2a13 13 0 0 1-13-13 12 12 0 0 1 3.11-7.53l2.36-2.36a4.93 4.93 0 0 0 .85-5.24l-.43-.84a6.1 6.1 0 0 0-4.87-3.03H145v35.02a8.08 8.08 0 0 1-4.13 6.66l-.84.43a6.91 6.91 0 0 1-7.56-1.22l-2.36-2.36A10.06 10.06 0 0 0 124 181a11 11 0 0 0-11 11h-2a13 13 0 0 1 13-13c2.47 0 5.79 1.37 7.53 3.11l2.36 2.36a4.94 4.94 0 0 0 5.24.85l.84-.43a6.1 6.1 0 0 0 3.03-4.87V145h-35.02a8.08 8.08 0 0 1-6.66-4.13l-.43-.84a6.91 6.91 0 0 1 1.22-7.56l2.36-2.36A10.06 10.06 0 0 0 107 124a11 11 0 0 0-22 0c0 1.94 1.16 4.75 2.53 6.11l2.36 2.36a6.93 6.93 0 0 1 1.22 7.56l-.43.84a8.08 8.08 0 0 1-6.66 4.13H49v35.02a6.1 6.1 0 0 0 3.03 4.87l.84.43c1.58.79 4 .4 5.24-.85l2.36-2.36a12.04 12.04 0 0 1 7.51-3.11A13 13 0 0 1 81 192h-2a11 11 0 0 0-11-11c-1.94 0-4.75 1.16-6.11 2.53l-2.36 2.36a6.93 6.93 0 0 1-7.56 1.22l-.84-.43a8.08 8.08 0 0 1-4.13-6.66V145H11.98a6.1 6.1 0 0 0-4.87 3.03l-.43.84c-.79 1.58-.4 4 .85 5.24l2.36 2.36a12.04 12.04 0 0 1 3.11 7.51A13 13 0 0 1 0 177v-2a11 11 0 0 0 11-11c0-1.94-1.16-4.75-2.53-6.11l-2.36-2.36a6.93 6.93 0 0 1-1.22-7.56l.43-.84a8.08 8.08 0 0 1 6.66-4.13H47v-35.02a6.1 6.1 0 0 0-3.03-4.87l-.84-.43c-1.59-.8-4-.4-5.24.85l-2.36 2.36A12 12 0 0 1 28 109a13 13 0 1 1 0-26c2.47 0 5.79 1.37 7.53 3.11l2.36 2.36a4.94 4.94 0 0 0 5.24.85l.84-.43A6.1 6.1 0 0 0 47 84.02V49H11.98a8.08 8.08 0 0 1-6.66-4.13l-.43-.84a6.91 6.91 0 0 1 1.22-7.56l2.36-2.36A10.06 10.06 0 0 0 11 28 11 11 0 0 0 0 17v-2a13 13 0 0 1 13 13c0 2.47-1.37 5.79-3.11 7.53l-2.36 2.36a4.94 4.94 0 0 0-.85 5.24l.43.84A6.1 6.1 0 0 0 11.98 47H47V11.98a8.08 8.08 0 0 1 4.13-6.66l.84-.43a6.91 6.91 0 0 1 7.56 1.22l2.36 2.36A10.06 10.06 0 0 0 68 11 11 11 0 0 0 79 0h2a13 13 0 0 1-13 13 12 12 0 0 1-7.53-3.11l-2.36-2.36a4.93 4.93 0 0 0-5.24-.85l-.84.43A6.1 6.1 0 0 0 49 11.98V47h35.02a8.08 8.08 0 0 1 6.66 4.13l.43.84a6.91 6.91 0 0 1-1.22 7.56l-2.36 2.36A10.06 10.06 0 0 0 85 68a11 11 0 0 0 22 0c0-1.94-1.16-4.75-2.53-6.11l-2.36-2.36a6.93 6.93 0 0 1-1.22-7.56l.43-.84a8.08 8.08 0 0 1 6.66-4.13H143V11.98a6.1 6.1 0 0 0-3.03-4.87l-.84-.43c-1.59-.8-4-.4-5.24.85l-2.36 2.36A12 12 0 0 1 124 13a13 13 0 0 1-13-13h2a11 11 0 0 0 11 11c1.94 0 4.75-1.16 6.11-2.53l2.36-2.36a6.93 6.93 0 0 1 7.56-1.22l.84.43a8.08 8.08 0 0 1 4.13 6.66V47h35.02a6.1 6.1 0 0 0 4.87-3.03l.43-.84c.8-1.59.4-4-.85-5.24l-2.36-2.36A12 12 0 0 1 179 28a13 13 0 0 1 13-13zM84.02 143a6.1 6.1 0 0 0 4.87-3.03l.43-.84c.8-1.59.4-4-.85-5.24l-2.36-2.36A12 12 0 0 1 83 124a13 13 0 1 1 26 0c0 2.47-1.37 5.79-3.11 7.53l-2.36 2.36a4.94 4.94 0 0 0-.85 5.24l.43.84a6.1 6.1 0 0 0 4.87 3.03H143v-35.02a8.08 8.08 0 0 1 4.13-6.66l.84-.43a6.91 6.91 0 0 1 7.56 1.22l2.36 2.36A10.06 10.06 0 0 0 164 107a11 11 0 0 0 0-22c-1.94 0-4.75 1.16-6.11 2.53l-2.36 2.36a6.93 6.93 0 0 1-7.56 1.22l-.84-.43a8.08 8.08 0 0 1-4.13-6.66V49h-35.02a6.1 6.1 0 0 0-4.87 3.03l-.43.84c-.79 1.58-.4 4 .85 5.24l2.36 2.36a12.04 12.04 0 0 1 3.11 7.51A13 13 0 1 1 83 68a12 12 0 0 1 3.11-7.53l2.36-2.36a4.93 4.93 0 0 0 .85-5.24l-.43-.84A6.1 6.1 0 0 0 84.02 49H49v35.02a8.08 8.08 0 0 1-4.13 6.66l-.84.43a6.91 6.91 0 0 1-7.56-1.22l-2.36-2.36A10.06 10.06 0 0 0 28 85a11 11 0 0 0 0 22c1.94 0 4.75-1.16 6.11-2.53l2.36-2.36a6.93 6.93 0 0 1 7.56-1.22l.84.43a8.08 8.08 0 0 1 4.13 6.66V143h35.02z'%3E%3C/path%3E%3C/svg%3E");
        }
        .cover {
          filter: brightness(0.6);
        }
      }
      .cover {
        width: auto;
        height: auto;
        min-height: 100%;
        opacity: 0;
        transition:
          filter 0.3s,
          opacity 0.3s;
        &.loaded {
          opacity: 1;
        }
      }
    }
    </style>
    
        <header class="main-header">
            <nav class="main-nav up top">
                <div class="nav-all">
                    
                     
                    <div class="left-nav">
                        
                        <div class="site-name" onclick="location.href='/'">
                            元视角
                        </div>
                    </div>
                    
                    
                    
                    <div class="nav-center">
                        <div class="site-menu"><div class="site-menu">
    
    <div class="menu-item">
        <span class="link-btn">文库</span>
        
        <div class="link-child">
            
            <span class="link-child-btn" onclick="window.location.href='\/archives'">
                
                <i class="iconfont icon-home"></i>
                
                文章列表
            </span>
            
            <span class="link-child-btn" onclick="window.location.href='\/categories'">
                
                <i class="iconfont icon-folder"></i>
                
                全部分类
            </span>
            
            <span class="link-child-btn" onclick="window.location.href='\/tags'">
                
                <i class="iconfont icon-hashtag"></i>
                
                全部标签
            </span>
            
        </div>
        
    </div>
    
    <div class="menu-item">
        <span class="link-btn">书影音</span>
        
        <div class="link-child">
            
            <span class="link-child-btn" onclick="window.location.href='\/reading'">
                
                <i class="iconfont icon-books"></i>
                
                读书
            </span>
            
            <span class="link-child-btn" onclick="window.location.href='\/watching'">
                
                <i class="iconfont icon-tv"></i>
                
                观影
            </span>
            
            <span class="link-child-btn" onclick="window.location.href='\/listening'">
                
                <i class="iconfont icon-music"></i>
                
                听歌
            </span>
            
        </div>
        
    </div>
    
    <div class="menu-item">
        <span class="link-btn">友链</span>
        
        <div class="link-child">
            
            <span class="link-child-btn" onclick="window.location.href='\/links'">
                
                <i class="iconfont icon-people"></i>
                
                友情链接
            </span>
            
        </div>
        
    </div>
    
    <div class="menu-item">
        <span class="link-btn">关于</span>
        
        <div class="link-child">
            
            <span class="link-child-btn" onclick="window.location.href='\/guestbook'">
                
                <i class="iconfont icon-chat"></i>
                
                留言板
            </span>
            
            <span class="link-child-btn" onclick="window.location.href='\/about'">
                
                <i class="iconfont icon-contacts"></i>
                
                关于本站
            </span>
            
        </div>
        
    </div>
    
</div></div>
                        <span class="site-title">
                            一道 HashSet 面试题引发的蝴蝶效应
                        </span>
                    </div>
                    
                    
                    <div class="right-nav">
                        
                        <a class="menu-btn nav-btn travellings" title="开往-友链接力" href="https://www.travellings.cn/go.html" target="_blank">
                            <i class="iconfont icon-subway"></i>
                        </a>
                        
                        <div class="menu-btn nav-btn" title="随机前往一篇文章">
                            <i class="iconfont icon-shuffle"></i>
                        </div>
                        
                        <div class="menu-btn nav-btn" title="全站搜索">
                            <i class="iconfont icon-search"></i>
                        </div>
                        
                        <div class="menu-btn nav-btn" id="themeToggle" title="切换主题模式">
                            <i class="iconfont icon-sun" id="themeIcon"></i>
                        </div>
                        
                        <div id="open-control" class="menu-btn nav-btn pc" title="打开中控台">
                            <i class="iconfont icon-dashboard"></i>
                        </div>
                        
                        <div class="to-top menu-btn" title="返回顶部">
                            <div class="to-top-btn">
                                <span class="num">0</span>
                                <i class="iconfont icon-up"></i>
                            </div>
                        </div>
                        
                        <div class="menu-btn nav-btn mobile" title="打开菜单">
                            <i class="iconfont icon-toc"></i>
                        </div>
                    </div>
                </div>
            </nav>
            <div class="mobile-menu" id="mobileMenu">
    
    <div class="menu-mask"></div>
    <div class="menu-content s-card">
        
        <div class="close-control">
            <i class="iconfont icon-close"></i>
        </div>

        
        <div class="menu-list">
            
            <div class="menu-item">
                <span class="link-title">文库</span>
                
                <div class="link-child">
                    
                    <div class="link-child-btn" onclick="window.location.href='\/archives'">
                        
                        <i class="iconfont icon-home"></i>
                        
                        <span class="name">文章列表</span>
                    </div>
                    
                    <div class="link-child-btn" onclick="window.location.href='\/categories'">
                        
                        <i class="iconfont icon-folder"></i>
                        
                        <span class="name">全部分类</span>
                    </div>
                    
                    <div class="link-child-btn" onclick="window.location.href='\/tags'">
                        
                        <i class="iconfont icon-hashtag"></i>
                        
                        <span class="name">全部标签</span>
                    </div>
                    
                </div>
                
            </div>
            
            <div class="menu-item">
                <span class="link-title">书影音</span>
                
                <div class="link-child">
                    
                    <div class="link-child-btn" onclick="window.location.href='\/reading'">
                        
                        <i class="iconfont icon-books"></i>
                        
                        <span class="name">读书</span>
                    </div>
                    
                    <div class="link-child-btn" onclick="window.location.href='\/watching'">
                        
                        <i class="iconfont icon-tv"></i>
                        
                        <span class="name">观影</span>
                    </div>
                    
                    <div class="link-child-btn" onclick="window.location.href='\/listening'">
                        
                        <i class="iconfont icon-music"></i>
                        
                        <span class="name">听歌</span>
                    </div>
                    
                </div>
                
            </div>
            
            <div class="menu-item">
                <span class="link-title">友链</span>
                
                <div class="link-child">
                    
                    <div class="link-child-btn" onclick="window.location.href='\/links'">
                        
                        <i class="iconfont icon-people"></i>
                        
                        <span class="name">友情链接</span>
                    </div>
                    
                </div>
                
            </div>
            
            <div class="menu-item">
                <span class="link-title">关于</span>
                
                <div class="link-child">
                    
                    <div class="link-child-btn" onclick="window.location.href='\/guestbook'">
                        
                        <i class="iconfont icon-chat"></i>
                        
                        <span class="name">留言板</span>
                    </div>
                    
                    <div class="link-child-btn" onclick="window.location.href='\/about'">
                        
                        <i class="iconfont icon-contacts"></i>
                        
                        <span class="name">关于本站</span>
                    </div>
                    
                </div>
                
            </div>
            
        </div>
    </div>
</div>

<style>
.mobile-menu {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 3000;
    display: none;
}

.mobile-menu .menu-mask {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    background-color: var(--main-mask-background);
}

.mobile-menu .menu-content {
    position: absolute;
    top: 0;
    right: 0;
    height: 100%;
    width: 100%;
    max-width: 300px;
    border-radius: 12px 0 0 12px;
    padding: 20px;
    overflow: auto;
}

.mobile-menu .close-control {
    position: absolute;
    top: 10px;
    right: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 35px;
    height: 35px;
    padding: 0;
    transition: background-color 0.3s, opacity 0.3s;
    border-radius: 50%;
    cursor: pointer;
}

.mobile-menu .close-control .iconfont {
    font-size: 18px;
    line-height: 1;
    color: var(--main-font-second-color);
    transition: color 0.3s, opacity 0.3s;
}

.mobile-menu .close-control:hover {
    background-color: var(--main-color);
}

.mobile-menu .close-control:hover .iconfont {
    color: var(--main-card-background);
}

.mobile-menu .menu-list {
    margin-top: 40px;
}

.mobile-menu .menu-item {
    margin-bottom: 12px;
}

.mobile-menu .menu-item .link-title {
    font-size: 14px;
    margin-bottom: 12px;
    display: inline-block;
    color: var(--main-font-second-color);
}

.mobile-menu .menu-item .link-child {
    display: grid;
    gap: 12px;
    grid-template-columns: 1fr 1fr;
}

.mobile-menu .menu-item .link-child-btn {
    display: flex;
    flex-direction: row;
    justify-content: flex-start;
    align-items: center;
    border-radius: 8px;
    padding: 10px 12px;
    background-color: var(--main-card-background);
    border: 1px solid var(--main-card-border);
    box-shadow: 0 8px 16px -4px var(--main-border-shadow);
    font-size: 15px;
    cursor: pointer;
    transition: all 0.3s;
}

.mobile-menu .menu-item .link-child-btn:hover {
    background-color: var(--main-color);
    color: var(--main-card-background);
}

.mobile-menu .menu-item .link-child-btn .iconfont {
    margin-right: 6px;
    opacity: 0.6;
}

.mobile-menu .menu-item .link-child-btn .name {
    max-width: 80px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
</style>

<script>
function toggleMobileMenu() {
    const mobileMenu = document.getElementById('mobileMenu');
    if (mobileMenu) {
        mobileMenu.style.display = mobileMenu.style.display === 'none' ? 'block' : 'none';
    }
}
</script> <div class="modal search-modal" id="searchModal">
  <div class="modal-container">
    <div class="modal-header">
      <div class="modal-title">
        <i class="iconfont icon-search"></i>
        <span>全局搜索</span>
      </div>
      <div class="modal-close">
        <i class="iconfont icon-close"></i>
      </div>
    </div>

    <div class="search-container">
      <div class="search-box">
        <input 
          type="text" 
          id="searchInput"
          placeholder="想要搜点什么" 
          autocomplete="off"
          autofocus
        >
      </div>

      <div class="search-results" id="searchResults">
        <div class="no-result" id="noResult" style="display: none;">
          <i class="iconfont icon-search-empty"></i>
          <span class="text">搜索结果为空</span>
        </div>
        <div class="search-list" id="searchList"></div>
      </div>

      <div class="search-stats">
        <span class="text" id="searchStats"></span>
      </div>
    </div>
  </div>
</div>

<style>
.search-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 999;
  display: none;
}

.modal-container {
  position: relative;
  width: 90%;
  max-width: 768px;
  margin: 80px auto;
  background-color: var(--main-card-background);
  border-radius: 12px;
  padding: 1.5rem;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.modal-title {
  display: flex;
  align-items: center;
  font-size: 1.2rem;
  font-weight: bold;
}

.modal-title .iconfont {
  margin-right: 0.5rem;
}

.modal-close {
  cursor: pointer;
  padding: 0.5rem;
}

.search-box input {
  width: 100%;
  outline: none;
  border-radius: 8px;
  font-size: 16px;
  padding: 0.6rem 1rem;
  color: var(--main-font-color);
  font-family: var(--main-font-family);
  border: 1px solid var(--main-card-border);
  background-color: var(--main-card-second-background);
  transition: border-color 0.3s, box-shadow 0.3s;
}

.search-box input:focus {
  border-color: var(--main-color);
  box-shadow: 0 8px 16px -4px var(--main-color-bg);
}

.search-results {
  margin-top: 20px;
  min-height: 300px;
}

.no-result {
  height: 300px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.no-result .iconfont {
  font-size: 40px;
  margin-bottom: 12px;
}

.no-result .text {
  font-size: 18px;
  opacity: 0.6;
}

.search-list .search-item {
  margin-bottom: 12px;
  padding: 1rem;
  border-radius: 8px;
  background-color: var(--main-card-second-background);
  cursor: pointer;
  transition: transform 0.3s;
}

.search-list .search-item:hover {
  transform: translateY(-2px);
}

.search-item .title {
  font-size: 16px;
  margin-bottom: 6px;
}

.search-item .content {
  color: var(--main-font-second-color);
  font-size: 14px;
  margin-top: 8px;
}

.search-stats {
  margin-top: 1rem;
  font-size: 14px;
  color: var(--main-font-second-color);
}

.highlight {
  color: var(--main-color);
  background: transparent;
}
</style> </header>

        
        <main class="main-layout">



<div class="post">
    <div class="post-meta">
        <div class="meta">
            
            <div class="categories">
                
                
                <a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80" class="cat-item">
                    <i class="iconfont icon-folder"></i>
                    <span class="name">编程语言</span>
                </a>
                
                
            </div>
            
            <div class="tags">
                
                
                <a href="/tags/hashset" class="tag-item">
                    <i class="iconfont icon-hashtag"></i>
                    <span class="name">HashSet</span>
                </a>
                
                <a href="/tags/%E7%BC%96%E7%A8%8B" class="tag-item">
                    <i class="iconfont icon-hashtag"></i>
                    <span class="name">编程</span>
                </a>
                
                <a href="/tags/%E9%9D%A2%E8%AF%95" class="tag-item">
                    <i class="iconfont icon-hashtag"></i>
                    <span class="name">面试</span>
                </a>
                
                <a href="/tags/%E6%BA%90%E7%A0%81" class="tag-item">
                    <i class="iconfont icon-hashtag"></i>
                    <span class="name">源码</span>
                </a>
                
                
            </div>
        </div>
        <h1 class="title">
            一道 HashSet 面试题引发的蝴蝶效应
        </h1>
        <div class="other-meta">
            
            <span class="meta date">
                <i class="iconfont icon-date"></i>
                2020-10-20
            </span>
            
            <span class="update meta">
                <i class="iconfont icon-time"></i>
                2020-10-20
            </span>
            
            <span class="hot meta">
                <i class="iconfont icon-fire"></i>
                <span id="twikoo_visitors" class="artalk-pv-count">0</span>
            </span>
            
            <span class="chat meta hover" data-scroll-to="comments">
                <i class="iconfont icon-chat"></i>
                <span id="twikoo_comments" class="artalk-comment-count">0</span>
            </span>
        </div>
    </div>
    <div class="post-content">
        <article class="post-article s-card">
            
            
            
            <div class="expired s-card">
                本文发表于 <strong>1623</strong> 天前，其中的信息可能已经事过境迁
            </div>
            

            
<div class="article-gpt s-card">
  <div class="title">
    <span class="name">
      <i class="iconfont icon-robot"></i>
      文章摘要
      <i class="iconfont icon-up"></i>
    </span>
    <span class="logo">FakeGPT</span>
  </div>
  <div class="content s-card">
    <span class="text"></span>
  </div>
  <div class="meta">
    
    
  </div>
</div>
<script src="https://npm.elemecdn.com/typeit@8.7.1/dist/index.umd.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    new TypeIt(".article-gpt .content .text", {
        strings: '在这篇文章中，作者通过解读 HashSet 的源代码，介绍了 HashSet 去重的原理以及与 IEqualityComparer\u003cT\u003e 接口的关系。进一步讨论了在排序和去重操作中的接口应用，包括 IEquatable\u003cT\u003e、IComparable\/IComparable\u003cT\u003e 和 IComparer\u003cT\u003e 接口的作用。通过对 HashSet、Dictionary 和去重操作的探讨，展示了这些数据结构和接口之间的联系，强调了在处理排序和去重时的重要性。整体上，文章通过解答一个关于 HashSet 的面试问题，深入探讨了涉及数据结构和接口的相关知识点，展示了技术知识体系中的连锁效应。',
        speed: 10,
        lifeLike: true,
        waitUntilVisible: true,
    }).go();
});
</script>



            
            <div id="page-content" class="markdown-main-style">
                <p>没错，我又借着“面试题”的名头来搞事情了，今天要说的是 HashSet ，而这确实是一个实际面试中遇到的问题。当时的场景大概是这样的，面试官在了解了你的知识广度以后，决心来考察一番你的基本功底，抛出了一个看起来平平无奇的问题：说一说你平时工作中都用到了哪些数据结构。你心想，这还不简单，<code>Array</code>、<code>ArrayList</code>、<code>List</code>、<code>Dictionary</code>、<code>HashSet</code>、<code>Stack</code>、<code>Queue</code>&hellip;等等各种集合类简直如数家珍，甚至你还能说出这些数据结构间的优劣以及各自使用的场景。可没想到，面试官话锋一转，直接来一句，“你能说说 HashSet 去重的原理吗”，好家伙，你这简直不按套路出牌啊&hellip;本着每次面试都有一点收获的初心，于是就有了今天这篇博客，不同的是，顺着这个思路继续深挖下去，博主又发现了几个平时关注不到的技术盲点，所以，博主称之为：一道 HashSet 面试题引发的蝴蝶效应。</p>
<h1 id="hashset-源代码解读">HashSet 源代码解读</h1>
<p>OK，首先，我们来回答第一个问题，即：<strong>HashSet 去重的原理是什么？</strong>。为此，博主翻阅了 HashSet 的 <a href="https://referencesource.microsoft.com/#System.Core/System/Collections/Generic/HashSet.cs,1044">源代码</a>。首先，我们会注意到 HashSet 的构造函数，它需要一个类型为<code>IEqualityComparer&lt;T&gt;</code>的参数。从这个命名上我们就可以知道，这是一个用于相等性比较的接口，我们初步推测，HashSet 去重应该和这个接口有关：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-CSharp" data-lang="CSharp"><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">HashSet</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">:</span> <span class="k">this</span><span class="p">(</span><span class="n">EqualityComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.</span><span class="n">Default</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">HashSet</span><span class="p">(</span><span class="kt">int</span> <span class="n">capacity</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">:</span> <span class="k">this</span><span class="p">(</span><span class="n">capacity</span><span class="p">,</span> <span class="n">EqualityComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.</span><span class="n">Default</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">HashSet</span><span class="p">(</span><span class="n">IEqualityComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">comparer</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">HashSet</span><span class="p">(</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">collection</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">:</span> <span class="k">this</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">EqualityComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.</span><span class="n">Default</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">HashSet</span><span class="p">(</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">collection</span><span class="p">,</span> <span class="n">IEqualityComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">comparer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">:</span> <span class="k">this</span><span class="p">(</span><span class="n">comparer</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span></span></code></pre></div><p>我们都知道 HashSet 可以去重，比如，我们向 HashSet 添加多个相同的元素，实际上 HashSet 中最终只会有一个元素。所以，我们自然而然地想到，看看 HashSet 中的 <code>Add()</code> 方法呗，或许能从这里看出一点端倪。HashSet 中一共有两个 <code>Add()</code> 方法，它们内部都调用了 <code>AddIfNotPresent()</code> 方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-CSharp" data-lang="CSharp"><span class="line"><span class="cl"><span class="k">void</span> <span class="n">ICollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.</span><span class="n">Add</span><span class="p">(</span><span class="n">T</span> <span class="n">item</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">AddIfNotPresent</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="kd">public</span> <span class="kt">bool</span> <span class="n">Add</span><span class="p">(</span><span class="n">T</span> <span class="n">item</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">AddIfNotPresent</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>继续循着蛛丝马迹一路 F12 ，我们来看看这个方法的具体实现：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-CSharp" data-lang="CSharp"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">bool</span> <span class="n">AddIfNotPresent</span><span class="p">(</span><span class="n">T</span> <span class="k">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">m_buckets</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Initialize</span><span class="p">(</span><span class="m">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">hashCode</span> <span class="p">=</span> <span class="n">InternalGetHashCode</span><span class="p">(</span><span class="k">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">bucket</span> <span class="p">=</span> <span class="n">hashCode</span> <span class="p">%</span> <span class="n">m_buckets</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cp">#if</span> <span class="n">FEATURE_RANDOMIZED_STRING_HASHING</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">FEATURE_NETCORE</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">collisionCount</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cp">#endif</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="n">m_buckets</span><span class="p">[</span><span class="n">hashCode</span> <span class="p">%</span> <span class="n">m_buckets</span><span class="p">.</span><span class="n">Length</span><span class="p">]</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">=</span> <span class="n">m_slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">m_slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hashCode</span> <span class="p">==</span> <span class="n">hashCode</span> <span class="p">&amp;&amp;</span> <span class="n">m_comparer</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">m_slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="k">value</span><span class="p">,</span> <span class="k">value</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="cp">#if</span> <span class="n">FEATURE_RANDOMIZED_STRING_HASHING</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">FEATURE_NETCORE</span>
</span></span><span class="line"><span class="cl">            <span class="n">collisionCount</span><span class="p">++;</span>
</span></span><span class="line"><span class="cl">        <span class="cp">#endif</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">m_freeList</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">index</span> <span class="p">=</span> <span class="n">m_freeList</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_freeList</span> <span class="p">=</span> <span class="n">m_slots</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">m_lastIndex</span> <span class="p">==</span> <span class="n">m_slots</span><span class="p">.</span><span class="n">Length</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">IncreaseCapacity</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// this will change during resize</span>
</span></span><span class="line"><span class="cl">            <span class="n">bucket</span> <span class="p">=</span> <span class="n">hashCode</span> <span class="p">%</span> <span class="n">m_buckets</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">index</span> <span class="p">=</span> <span class="n">m_lastIndex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_lastIndex</span><span class="p">++;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">m_slots</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">hashCode</span> <span class="p">=</span> <span class="n">hashCode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">m_slots</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="k">value</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">m_slots</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">next</span> <span class="p">=</span> <span class="n">m_buckets</span><span class="p">[</span><span class="n">bucket</span><span class="p">]</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">m_buckets</span><span class="p">[</span><span class="n">bucket</span><span class="p">]</span> <span class="p">=</span> <span class="n">index</span> <span class="p">+</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">m_count</span><span class="p">++;</span>
</span></span><span class="line"><span class="cl">    <span class="n">m_version</span><span class="p">++;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="cp">#if</span> <span class="n">FEATURE_RANDOMIZED_STRING_HASHING</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">FEATURE_NETCORE</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">collisionCount</span> <span class="p">&gt;</span> <span class="n">HashHelpers</span><span class="p">.</span><span class="n">HashCollisionThreshold</span> <span class="p">&amp;&amp;</span> <span class="n">HashHelpers</span><span class="p">.</span><span class="n">IsWellKnownEqualityComparer</span><span class="p">(</span><span class="n">m_comparer</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_comparer</span> <span class="p">=</span> <span class="p">(</span><span class="n">IEqualityComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;)</span> <span class="n">HashHelpers</span><span class="p">.</span><span class="n">GetRandomizedEqualityComparer</span><span class="p">(</span><span class="n">m_comparer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">SetCapacity</span><span class="p">(</span><span class="n">m_buckets</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="cp">#endif</span> <span class="c1">// FEATURE_RANDOMIZED_STRING_HASHING</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>可以注意到，在这段代码中，首先，会通过 <code>InternalGetHashCode()</code> 方法计算一个 HashCode。其中，<code>Lower31BitMask</code> 是一个常量 <code>0x7FFFFFFF</code> ：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-CSharp" data-lang="CSharp"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">int</span> <span class="n">InternalGetHashCode</span><span class="p">(</span><span class="n">T</span> <span class="n">item</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">item</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> 
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">m_comparer</span><span class="p">.</span><span class="n">GetHashCode</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="p">&amp;</span> <span class="n">Lower31BitMask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>接下来，在 HashSet 内部使用了<code>Slot</code> 这个结构来存储元素，该结构设计上类似于链表，每一个 <code>Slot</code> 中都记录对应元素的值、HashCode 以及下一个元素的索引。所以，只需要对它做一次遍历，如果对应元素的 HashCode 和 值 都相等，则认为该元素在 HashSet中已经存在了。此时，<code>AddIfNotPresent()</code> 方法会返回 false。这就是 HashSet 去重的原理啦。在比较元素的值是否相等的时候，我们前面提到的 <code>IEqualityComparer&lt;T&gt;</code> 终于登场，它提供的 <code>Equals()</code> 方法恰好可以比较两个元素是否相等：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-CSharp" data-lang="CSharp"><span class="line"><span class="cl"><span class="kd">internal</span> <span class="k">struct</span> <span class="nc">Slot</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">internal</span> <span class="kt">int</span> <span class="n">hashCode</span><span class="p">;</span>  <span class="c1">// Lower 31 bits of hash code, -1 if unused</span>
</span></span><span class="line"><span class="cl">    <span class="kd">internal</span> <span class="kt">int</span> <span class="n">next</span><span class="p">;</span>  <span class="c1">// Index of next entry, -1 if last</span>
</span></span><span class="line"><span class="cl">    <span class="kd">internal</span> <span class="n">T</span> <span class="k">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">interface</span> <span class="nc">IEqualityComparer</span><span class="p">&lt;</span><span class="k">in</span> <span class="n">T</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">Equals</span><span class="p">(</span><span class="n">T</span> <span class="n">x</span><span class="p">,</span> <span class="n">T</span> <span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">GetHashCode</span><span class="p">(</span><span class="n">T</span> <span class="n">obj</span><span class="p">);</span>                
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>再接下来，如果对应元素的 HashCode 或 值 都不相等，则认为该元素在 HashSet 中不存在。此时，需要考虑 HashSet 的容量是否足以放得下这个新元素。在容量不满足的情况下，就需要对 HashSet 进行扩容。值得一提的是，这里是使用质数进行扩容的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-CSharp" data-lang="CSharp"><span class="line"><span class="cl"><span class="kd">private</span> <span class="k">void</span> <span class="n">IncreaseCapacity</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">m_buckets</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">,</span> <span class="s">&#34;IncreaseCapacity called on a set with no elements&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">newSize</span> <span class="p">=</span> <span class="n">HashHelpers</span><span class="p">.</span><span class="n">ExpandPrime</span><span class="p">(</span><span class="n">m_count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">newSize</span> <span class="p">&lt;=</span> <span class="n">m_count</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">ArgumentException</span><span class="p">(</span><span class="n">SR</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="n">SR</span><span class="p">.</span><span class="n">Arg_HSCapacityOverflow</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="c1">// Able to increase capacity; copy elements to larger array and rehash</span>
</span></span><span class="line"><span class="cl">    <span class="n">SetCapacity</span><span class="p">(</span><span class="n">newSize</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">ExpandPrime</span><span class="p">(</span><span class="kt">int</span> <span class="n">oldSize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">newSize</span> <span class="p">=</span> <span class="m">2</span> <span class="p">*</span> <span class="n">oldSize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="c1">// Allow the hashtables to grow to maximum possible size (~2G elements) before encoutering capacity overflow.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Note that this check works even when _items.Length overflowed thanks to the (uint) cast</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">((</span><span class="kt">uint</span><span class="p">)</span><span class="n">newSize</span> <span class="p">&gt;</span> <span class="n">MaxPrimeArrayLength</span> <span class="p">&amp;&amp;</span> <span class="n">MaxPrimeArrayLength</span> <span class="p">&gt;</span> <span class="n">oldSize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Contract</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span> <span class="n">MaxPrimeArrayLength</span> <span class="p">==</span> <span class="n">GetPrime</span><span class="p">(</span><span class="n">MaxPrimeArrayLength</span><span class="p">),</span> <span class="s">&#34;Invalid MaxPrimeArrayLength&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">MaxPrimeArrayLength</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">GetPrime</span><span class="p">(</span><span class="n">newSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h1 id="iequalitycomparert接口">IEqualityComparer<!-- raw HTML omitted -->接口</h1>
<p>OK，现在我们知道了，HashSet 之所以可以去重，一个重要的原因是 <code>IEqualityComparer&lt;T&gt;</code> 。而回到这个接口本身呢，它只有 <code>Equals()</code> 和 <code>GetHashCode()</code>，这其实非常符合我们的认知，因为这两个方法在对象相等的场景中十分常见，有一个准则是：如果重写了 <code>Equals()</code> 方法，那么，应该同时去重写 <code>GetHashCode()</code> 方法，即，两者在表达相等这个含义时应该具有一致性。这里可能会有一点疑问，那就是，我们平时使用 HashSet 的时候，完全不需要指定 <code>IEqualityComparer&lt;T&gt;</code> ，它一样可以正常工作啊？没错，这是因为微软提供了一个默认的实现：<code>EqualityComparer&lt;T&gt;.Default</code>。我们同样来看看它的实现：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-CSharp" data-lang="CSharp"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="n">EqualityComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">CreateComparer</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Contract</span><span class="p">.</span><span class="n">Ensures</span><span class="p">(</span><span class="n">Contract</span><span class="p">.</span><span class="n">Result</span><span class="p">&lt;</span><span class="n">EqualityComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;()</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="n">RuntimeType</span> <span class="n">t</span> <span class="p">=</span> <span class="p">(</span><span class="n">RuntimeType</span><span class="p">)</span><span class="k">typeof</span><span class="p">(</span><span class="n">T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Specialize type byte for performance reasons</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="kt">byte</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="n">EqualityComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;)(</span><span class="kt">object</span><span class="p">)(</span><span class="k">new</span> <span class="n">ByteEqualityComparer</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// If T implements IEquatable&lt;T&gt; return a GenericEqualityComparer&lt;T&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IEquatable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;).</span><span class="n">IsAssignableFrom</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="n">EqualityComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;)</span><span class="n">RuntimeTypeHandle</span><span class="p">.</span><span class="n">CreateInstanceForAnotherGenericParameter</span><span class="p">((</span><span class="n">RuntimeType</span><span class="p">)</span><span class="k">typeof</span><span class="p">(</span><span class="n">GenericEqualityComparer</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;),</span> <span class="n">t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// If T is a Nullable&lt;U&gt; where U implements IEquatable&lt;U&gt; return a NullableEqualityComparer&lt;U&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">IsGenericType</span> <span class="p">&amp;&amp;</span> <span class="n">t</span><span class="p">.</span><span class="n">GetGenericTypeDefinition</span><span class="p">()</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Nullable</span><span class="p">&lt;&gt;))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">RuntimeType</span> <span class="n">u</span> <span class="p">=</span> <span class="p">(</span><span class="n">RuntimeType</span><span class="p">)</span><span class="n">t</span><span class="p">.</span><span class="n">GetGenericArguments</span><span class="p">()[</span><span class="m">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IEquatable</span><span class="p">&lt;&gt;).</span><span class="n">MakeGenericType</span><span class="p">(</span><span class="n">u</span><span class="p">).</span><span class="n">IsAssignableFrom</span><span class="p">(</span><span class="n">u</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">(</span><span class="n">EqualityComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;)</span><span class="n">RuntimeTypeHandle</span><span class="p">.</span><span class="n">CreateInstanceForAnotherGenericParameter</span><span class="p">((</span><span class="n">RuntimeType</span><span class="p">)</span><span class="k">typeof</span><span class="p">(</span><span class="n">NullableEqualityComparer</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;),</span> <span class="n">u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">    <span class="c1">// See the METHOD__JIT_HELPERS__UNSAFE_ENUM_CAST and METHOD__JIT_HELPERS__UNSAFE_ENUM_CAST_LONG cases in getILIntrinsicImplementation</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">IsEnum</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">TypeCode</span> <span class="n">underlyingTypeCode</span> <span class="p">=</span> <span class="n">Type</span><span class="p">.</span><span class="n">GetTypeCode</span><span class="p">(</span><span class="n">Enum</span><span class="p">.</span><span class="n">GetUnderlyingType</span><span class="p">(</span><span class="n">t</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">        <span class="c1">// Depending on the enum type, we need to special case the comparers so that we avoid boxing</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Note: We have different comparers for Short and SByte because for those types we need to make sure we call GetHashCode on the actual underlying type as the </span>
</span></span><span class="line"><span class="cl">        <span class="c1">// implementation of GetHashCode is more complex than for the other types.</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="p">(</span><span class="n">underlyingTypeCode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="n">TypeCode</span><span class="p">.</span><span class="n">Int16</span><span class="p">:</span> <span class="c1">// short</span>
</span></span><span class="line"><span class="cl">               <span class="k">return</span> <span class="p">(</span><span class="n">EqualityComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;)</span><span class="n">RuntimeTypeHandle</span><span class="p">.</span><span class="n">CreateInstanceForAnotherGenericParameter</span><span class="p">((</span><span class="n">RuntimeType</span><span class="p">)</span><span class="k">typeof</span><span class="p">(</span><span class="n">ShortEnumEqualityComparer</span><span class="p">&lt;</span><span class="kt">short</span><span class="p">&gt;),</span> <span class="n">t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="n">TypeCode</span><span class="p">.</span><span class="n">SByte</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="p">(</span><span class="n">EqualityComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;)</span><span class="n">RuntimeTypeHandle</span><span class="p">.</span><span class="n">CreateInstanceForAnotherGenericParameter</span><span class="p">((</span><span class="n">RuntimeType</span><span class="p">)</span><span class="k">typeof</span><span class="p">(</span><span class="n">SByteEnumEqualityComparer</span><span class="p">&lt;</span><span class="kt">sbyte</span><span class="p">&gt;),</span> <span class="n">t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="n">TypeCode</span><span class="p">.</span><span class="n">Int32</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="n">TypeCode</span><span class="p">.</span><span class="n">UInt32</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="n">TypeCode</span><span class="p">.</span><span class="n">Byte</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="n">TypeCode</span><span class="p">.</span><span class="n">UInt16</span><span class="p">:</span> <span class="c1">//ushort</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="p">(</span><span class="n">EqualityComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;)</span><span class="n">RuntimeTypeHandle</span><span class="p">.</span><span class="n">CreateInstanceForAnotherGenericParameter</span><span class="p">((</span><span class="n">RuntimeType</span><span class="p">)</span><span class="k">typeof</span><span class="p">(</span><span class="n">EnumEqualityComparer</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;),</span> <span class="n">t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="n">TypeCode</span><span class="p">.</span><span class="n">Int64</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="n">TypeCode</span><span class="p">.</span><span class="n">UInt64</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="p">(</span><span class="n">EqualityComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;)</span><span class="n">RuntimeTypeHandle</span><span class="p">.</span><span class="n">CreateInstanceForAnotherGenericParameter</span><span class="p">((</span><span class="n">RuntimeType</span><span class="p">)</span><span class="k">typeof</span><span class="p">(</span><span class="n">LongEnumEqualityComparer</span><span class="p">&lt;</span><span class="kt">long</span><span class="p">&gt;),</span> <span class="n">t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Otherwise return an ObjectEqualityComparer&lt;T&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">ObjectEqualityComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>在这里，<code>EqualityComparer&lt;T&gt;</code> 类是一个抽象类，实现了 <code>IEqualityComparer&lt;T&gt;</code> 接口。简单来说，对于简单类型如整型、字节型等，微软实现了相应的 <code>IEqualityComparer&lt;T&gt;</code> 接口；而对于复杂的类型，微软提供了 <code>ObjectEqualityComparer&lt;T&gt;</code> 这一实现：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-CSharp" data-lang="CSharp"><span class="line"><span class="cl"><span class="kd">internal</span> <span class="k">class</span> <span class="nc">ObjectEqualityComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;:</span> <span class="n">EqualityComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Pure]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">override</span> <span class="kt">bool</span> <span class="n">Equals</span><span class="p">(</span><span class="n">T</span> <span class="n">x</span><span class="p">,</span> <span class="n">T</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="n">x</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="na"> 
</span></span></span><span class="line"><span class="cl"><span class="na">    [Pure]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">override</span> <span class="kt">int</span> <span class="n">GetHashCode</span><span class="p">(</span><span class="n">T</span> <span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">obj</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">obj</span><span class="p">.</span><span class="n">GetHashCode</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>所以，现在又回到我们刚刚聊起的话题，为什么说一个类型的 <code>Equals()</code> 和 <code>GetHashCode()</code> 方法非常重要呢？因为如果我们不能正确地实现这两个方法，微软实现的这个  <code>ObjectEqualityComparer&lt;T&gt;</code> 就会出现问题，导致 HashSet 在判断元素是否存在时出现问题，所以，这是一系列的连锁反应。有人可能会问，博主你说的这个好夸张耶，像我就从来没有重写过这两个方法。OK，现在来回答我的一个问题，如果你定义了一个类型 <code>Foo</code> ，并尝试用它作为一个字典中的 Key ，那么，你觉得这个字典应该怎么判断这个 Key 是否存在呢？我觉得这是一个好问题，因为它引发了我们在 .NET 知识体系中的蝴蝶效应。</p>
<h1 id="排序与去重是亲家">排序与去重是亲家</h1>
<p>排序与去重，在我看来是亲家关系，因为两者都需要“比较”。所以，下面我想从 .NET 中选取一部分接口来阐述我的观点，以及当我们有了 LINQ 以后，是否就应该抛弃它们。可能这些接口大家平时都用不到多少，但我还是想花点时间来梳理这些知识盲点，因为我发现，与其为整个行业 35 岁的的职业生涯而焦虑，倒不如重新捡起这个行业的初心，好好地学一学数据结构、算法和数学。整个行业的火热，容易让每一个人都陷入一种“我非常厉害”的错觉，我写博客的时候，在心里想了这样一句话：<strong>战士上战场，整天就知道 CRUD，连 HashSet 都不知道，早晚是个死</strong>。用王布斯的口吻说出来，会不会有一种紧迫感呢？</p>
<h2 id="iequatablet接口">IEquatable<!-- raw HTML omitted -->接口</h2>
<p><code>IEquatable&lt;T&gt;</code> 接口在微软官方文档中的定义是，<strong>定义值类型或类实现的通用方法，以创建用于确定实例相等性的类型特定方法</strong>。我承认，这不是一个特别好的定义，不过，我们可以换个角度来审视这个接口存在的意义。虽然 <code>Object</code> 这个基类提供了 <code>Equals()</code> 方法，但是这个方法只能接受一个 <code>object</code> 类型的参数， 所以，它本身会面临<strong>类型安全性缺失</strong>和<strong>装箱</strong>两个问题。为了解决这个问题，就必须要定义一个新的 <code>Equals()</code> 方法，确保它可以接收和当前类型一致的参数，所以就需要这样一个接口，你可以理解为它是 <code>Equals()</code> 方法的泛型版本，而众所周知 C# 是一门不支持多继承的语言，所以，这里只能以接口的形式提供出来。这里说一下我的结论，<code>IEquatable&lt;T&gt;</code> 接口对值类型更有用一点，相反，对引用类型就没有那么有用，因为它没有考虑到协变的问题，对引用类型的继承相对无力。下面是一个简单的例子：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-CSharp" data-lang="CSharp"><span class="line"><span class="cl"><span class="c1">//定义类型Foo，实现IEquatable&lt;Foo&gt;接口</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">Foo</span> <span class="p">:</span> <span class="n">IEquatable</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">decimal</span> <span class="n">Value</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">decimal</span> <span class="n">Weight</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">override</span> <span class="kt">bool</span> <span class="n">Equals</span><span class="p">(</span><span class="kt">object</span> <span class="n">other</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Equals</span><span class="p">(</span><span class="n">other</span> <span class="k">as</span> <span class="n">Foo</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">bool</span> <span class="n">Equals</span><span class="p">(</span><span class="n">Foo</span> <span class="n">other</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">other</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="n">other</span><span class="p">.</span><span class="n">Value</span> <span class="p">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="n">Weight</span> <span class="p">==</span> <span class="n">other</span><span class="p">.</span><span class="n">Weight</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//平平无奇的代码</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">foo1</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Foo</span><span class="p">()</span> <span class="p">{</span> <span class="n">Value</span> <span class="p">=</span> <span class="m">10</span><span class="p">,</span> <span class="n">Weight</span> <span class="p">=</span> <span class="m">1.0</span><span class="n">M</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">foo2</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Foo</span><span class="p">()</span> <span class="p">{</span> <span class="n">Value</span> <span class="p">=</span> <span class="m">10</span><span class="p">,</span> <span class="n">Weight</span> <span class="p">=</span> <span class="m">1.0</span><span class="n">M</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="n">foo1</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">foo2</span><span class="p">));</span>
</span></span></code></pre></div><h2 id="icompareableicompareablet接口">ICompareable/ICompareable<!-- raw HTML omitted -->接口</h2>
<p><code>ICompareable</code> 和 <code>ICompareable&lt;T&gt;</code>是是同一个接口的非泛型与泛型版本，都需要实现 <code>CompareTo()</code> 方法。可能大家会觉得这几个接口都差不多啊，实际上，大家细心观察就能发现它们的区别，“相等”这一类的接口的返回值是布尔型，关注的是两个对象是否相等；而“比较”这一类的接口的返回值是整数型，关注的是哪个大哪个小。我们继续以 <code>Foo</code> 这个类型为例，分别实现<code>IComparerable</code>  和 <code>IComparerable&lt;T&gt;</code>两个接口：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-CSharp" data-lang="CSharp"><span class="line"><span class="cl"><span class="c1">//继续实现IComparable, IComparable&lt;Foo&gt;接口</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">Foo</span> <span class="p">:</span> <span class="n">IEquatable</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;,</span> <span class="n">IComparable</span><span class="p">,</span> <span class="n">IComparable</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">decimal</span> <span class="n">Value</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">decimal</span> <span class="n">Weight</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">override</span> <span class="kt">bool</span> <span class="n">Equals</span><span class="p">(</span><span class="kt">object</span> <span class="n">other</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Equals</span><span class="p">(</span><span class="n">other</span> <span class="k">as</span> <span class="n">Foo</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">bool</span> <span class="n">Equals</span><span class="p">(</span><span class="n">Foo</span> <span class="n">other</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">other</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="n">other</span><span class="p">.</span><span class="n">Value</span> <span class="p">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="n">Weight</span> <span class="p">==</span> <span class="n">other</span><span class="p">.</span><span class="n">Weight</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="n">CompareTo</span><span class="p">(</span><span class="kt">object</span> <span class="n">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">other</span> <span class="p">=</span> <span class="n">obj</span> <span class="k">as</span> <span class="n">Foo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">CompareTo</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="n">CompareTo</span><span class="p">([</span><span class="n">AllowNull</span><span class="p">]</span> <span class="n">Foo</span> <span class="n">other</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">other</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="n">Value</span> <span class="p">*</span> <span class="n">Weight</span><span class="p">)</span> <span class="p">-</span> <span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">Value</span> <span class="p">*</span> <span class="n">other</span><span class="p">.</span><span class="n">Weight</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//平平无奇的代码</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">foo1</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Foo</span><span class="p">()</span> <span class="p">{</span> <span class="n">Value</span> <span class="p">=</span> <span class="m">10</span><span class="p">,</span> <span class="n">Weight</span> <span class="p">=</span> <span class="m">1.0</span><span class="n">M</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">foo2</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Foo</span><span class="p">()</span> <span class="p">{</span> <span class="n">Value</span> <span class="p">=</span> <span class="m">20</span><span class="p">,</span> <span class="n">Weight</span> <span class="p">=</span> <span class="m">1.0</span><span class="n">M</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">foo2</span><span class="p">.</span><span class="n">CompareTo</span><span class="p">(</span><span class="n">foo1</span><span class="p">)</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">);</span>
</span></span></code></pre></div><h2 id="icomparert接口">IComparer<!-- raw HTML omitted -->接口</h2>
<p>对于排序来说，理论上有<code>ICompareable</code> 和 <code>ICompareable&lt;T&gt;</code>这两个接口就可以了，为什么还要再定义一组接口呢？其实，我们结合生活中的场景就能想明白，不管是判断两个对象是否相等，还是对两个对象进行排序，这些条件都属于“变量”。<code>ICompareable</code> 和 <code>ICompareable&lt;T&gt;</code>这两个接口设计上的确没什么问题，但这都是一锤子买卖，一旦实现了对应的接口，就意味着如何比较两个对象的逻辑是确定好了的。可生活常识告诉我们，同一组信息不同的人考虑的维度是不一样的，譬如学生的成绩，可以按照某一个科目的成绩来排序，还可以按照各个科目的总成绩甚至是平均分来排序。对于上面的类型 <code>Foo</code>，我们不妨考虑按照 <code>Value</code> 和 <code>Weight</code> 分别进行排序，此时可以这样写：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-CSharp" data-lang="CSharp"><span class="line"><span class="cl"><span class="c1">//按Value排序</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">FooValueComparer</span> <span class="p">:</span> <span class="n">IComparer</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="n">Compare</span><span class="p">([</span><span class="n">AllowNull</span><span class="p">]</span> <span class="n">Foo</span> <span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="n">AllowNull</span><span class="p">]</span> <span class="n">Foo</span> <span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="p">==</span> <span class="kc">null</span> <span class="p">&amp;&amp;</span> <span class="n">y</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="p">!=</span> <span class="kc">null</span> <span class="p">&amp;&amp;</span> <span class="n">y</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="p">==</span> <span class="kc">null</span> <span class="p">&amp;&amp;</span> <span class="n">y</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">x</span><span class="p">.</span><span class="n">Value</span> <span class="p">-</span> <span class="n">y</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//按Weight排序</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">FooWeightComparer</span> <span class="p">:</span> <span class="n">IComparer</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="n">Compare</span><span class="p">([</span><span class="n">AllowNull</span><span class="p">]</span> <span class="n">Foo</span> <span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="n">AllowNull</span><span class="p">]</span> <span class="n">Foo</span> <span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="p">==</span> <span class="kc">null</span> <span class="p">&amp;&amp;</span> <span class="n">y</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="p">!=</span> <span class="kc">null</span> <span class="p">&amp;&amp;</span> <span class="n">y</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="p">==</span> <span class="kc">null</span> <span class="p">&amp;&amp;</span> <span class="n">y</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">x</span><span class="p">.</span><span class="n">Weight</span> <span class="p">-</span> <span class="n">y</span><span class="p">.</span><span class="n">Weight</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//平平无奇的代码</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">list</span><span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;{</span>
</span></span><span class="line"><span class="cl">    <span class="k">new</span> <span class="n">Foo</span><span class="p">()</span> <span class="p">{</span> <span class="n">Value</span> <span class="p">=</span> <span class="m">10</span><span class="p">,</span> <span class="n">Weight</span> <span class="p">=</span> <span class="m">2.0</span><span class="n">M</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="k">new</span> <span class="n">Foo</span><span class="p">()</span> <span class="p">{</span> <span class="n">Value</span> <span class="p">=</span> <span class="m">10</span><span class="p">,</span> <span class="n">Weight</span> <span class="p">=</span> <span class="m">1.0</span><span class="n">M</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//使用默认的排序器</span>
</span></span><span class="line"><span class="cl"><span class="n">list</span><span class="p">.</span><span class="n">Sort</span><span class="p">();</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//按Value进行排序</span>
</span></span><span class="line"><span class="cl"><span class="n">list</span><span class="p">.</span><span class="n">Sort</span><span class="p">(</span><span class="k">new</span> <span class="n">FooValueComparer</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="n">list</span><span class="p">.</span><span class="n">OrderBy</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//按Weight进行排序</span>
</span></span><span class="line"><span class="cl"><span class="n">list</span><span class="p">.</span><span class="n">Sort</span><span class="p">(</span><span class="k">new</span> <span class="n">FooWeightComparer</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="n">list</span><span class="p">.</span><span class="n">OrderBy</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Weight</span><span class="p">);</span>
</span></span></code></pre></div><p>在这里有一个点是，在不指定排序器的时候，微软帮我们提供了一个默认的排序器。而这个默认排序器会遵循这样的策略。如果类型 T 实现了 <code>IComparable&lt;T&gt;</code> 接口，则返回 <code>GenericComparer&lt;int&gt;</code> 实例；如果类型 T 实现是一个可空类型 <code>Nullable&lt;U&gt;</code> 并且类型 U 实现了 <code>IComparable&lt;T&gt;</code> 接口，则返回 <code>NullableComparer&lt;int&gt;</code> 实例；否则返回 <code>ObjectComparer&lt;T&gt;</code> 实例。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-CSharp" data-lang="CSharp"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="n">Comparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">CreateComparer</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">RuntimeType</span> <span class="n">t</span> <span class="p">=</span> <span class="p">(</span><span class="n">RuntimeType</span><span class="p">)</span><span class="k">typeof</span><span class="p">(</span><span class="n">T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="c1">// If T implements IComparable&lt;T&gt; return a GenericComparer&lt;T&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cp">#if</span> <span class="n">FEATURE_LEGACYNETCF</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Pre-Apollo Windows Phone call the overload that sorts the keys, not values this achieves the same result</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">CompatibilitySwitches</span><span class="p">.</span><span class="n">IsAppEarlierThanWindowsPhone8</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">ImplementInterface</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IComparable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="p">(</span><span class="n">Comparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;)</span><span class="n">RuntimeTypeHandle</span><span class="p">.</span><span class="n">CreateInstanceForAnotherGenericParameter</span><span class="p">((</span><span class="n">RuntimeType</span><span class="p">)</span><span class="k">typeof</span><span class="p">(</span><span class="n">GenericComparer</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;),</span> <span class="n">t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="cp">#endif</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IComparable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;).</span><span class="n">IsAssignableFrom</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">(</span><span class="n">Comparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;)</span><span class="n">RuntimeTypeHandle</span><span class="p">.</span><span class="n">CreateInstanceForAnotherGenericParameter</span><span class="p">((</span><span class="n">RuntimeType</span><span class="p">)</span><span class="k">typeof</span><span class="p">(</span><span class="n">GenericComparer</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;),</span> <span class="n">t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="c1">// If T is a Nullable&lt;U&gt; where U implements IComparable&lt;U&gt; return a NullableComparer&lt;U&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">IsGenericType</span> <span class="p">&amp;&amp;</span> <span class="n">t</span><span class="p">.</span><span class="n">GetGenericTypeDefinition</span><span class="p">()</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Nullable</span><span class="p">&lt;&gt;))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">RuntimeType</span> <span class="n">u</span> <span class="p">=</span> <span class="p">(</span><span class="n">RuntimeType</span><span class="p">)</span><span class="n">t</span><span class="p">.</span><span class="n">GetGenericArguments</span><span class="p">()[</span><span class="m">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IComparable</span><span class="p">&lt;&gt;).</span><span class="n">MakeGenericType</span><span class="p">(</span><span class="n">u</span><span class="p">).</span><span class="n">IsAssignableFrom</span><span class="p">(</span><span class="n">u</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">(</span><span class="n">Comparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;)</span><span class="n">RuntimeTypeHandle</span><span class="p">.</span><span class="n">CreateInstanceForAnotherGenericParameter</span><span class="p">((</span><span class="n">RuntimeType</span><span class="p">)</span><span class="k">typeof</span><span class="p">(</span><span class="n">NullableComparer</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;),</span> <span class="n">u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Otherwise return an ObjectComparer&lt;T&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">ObjectComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>更有意思的是，<code>GenericComparer&lt;T&gt;</code> 就是利用 <code>IComparable&lt;T&gt;</code> 的 <code>CompareTo()</code> 方法来说实现的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-CSharp" data-lang="CSharp"><span class="line"><span class="cl"><span class="kd">internal</span> <span class="k">class</span> <span class="nc">GenericComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">Comparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="k">where</span> <span class="n">T</span><span class="p">:</span> <span class="n">IComparable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>    
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">override</span> <span class="kt">int</span> <span class="n">Compare</span><span class="p">(</span><span class="n">T</span> <span class="n">x</span><span class="p">,</span> <span class="n">T</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="n">x</span><span class="p">.</span><span class="n">CompareTo</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="c1">// Equals method for the comparer itself. </span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">override</span> <span class="kt">bool</span> <span class="n">Equals</span><span class="p">(</span><span class="n">Object</span> <span class="n">obj</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">GenericComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">comparer</span> <span class="p">=</span> <span class="n">obj</span> <span class="k">as</span> <span class="n">GenericComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">comparer</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>        
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">override</span> <span class="kt">int</span> <span class="n">GetHashCode</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">GetType</span><span class="p">().</span><span class="n">Name</span><span class="p">.</span><span class="n">GetHashCode</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>在我们有了 <code>LINQ</code> 以后，通过 <code>OrderBy</code> 和 <code>OrderByDescending</code> 就可以进行排序，如果这个排序字段是一个简单类型，比如字符型、整型、日期型，这些简单类型微软都已经实现了相应的“排序”逻辑，而如果这个排序字段是一个复杂类型，比如一个自定义的类或者结构，此时，为了让这些方法能够“适应”这些复杂类型，最好的还是去实现 <code>IComparer&lt;T&gt;</code> 或者 <code>ICompareable&lt;T&gt;</code> 接口，然后传递给这两个排序方法。类似地，还有 <code>Distinct</code> 这个方法，它接收一个 <code>IEqualityComparer&lt;T&gt;</code> 类型的参数，所以，当你对一个列表进行去重(<strong>Distinct</strong>)操作时，千万不要想当然地人为它会按照你的期望去去重，如果结果不符合你的期望，很大原因是你没有给它提供一个合适的<code>IEqualityComparer&lt;T&gt;</code> 。所以，你看，我们绕了一大圈，从 HashSet 说到 <code>IEqualityComparer&lt;T&gt;</code>，又从排序说到去重，最终又回到了起点，这是多么有趣的一件事情。而去重(<strong>Distinct</strong>)这件事情，其实涉及到<code>Dictionary</code> 和 <code>HashSet</code> 两个数据结构，通过结构来推演性质，又通过性质来扫清盲点，这可能是这段时间刷 LeetCode 最大的一个收获吧！</p>
<h1 id="本文小结">本文小结</h1>
<p>面试中偶然遇到的 HashSet 问题，让我发现自己的知识体系中存在着盲点。通过解读 HashSet 源代码，我们认识到 HashSet 可以去重的一个重要原因是<code>IEqualityComparer&lt;T&gt;</code> 接口，它决定了两个对象的实例在什么情况下可以被判定为相等。而这个接口，不单单在 HashSet 出现，在 Dictionary 中同样会出现，甚至在我们最熟悉不过的去重(<strong>Distinct</strong>)中还会出现，所以，通过 HashSet 这一个点上的疑问，我搞清楚了很多相关联的内容，这不是蝴蝶效应又是什么呢？而与去重(<strong>Distinct</strong>)相关联的则是排序，在此基础上，对 <code>IEquatable&lt;T&gt;</code> 接口、<code>ICompareable</code>/<code>ICompareable&lt;T&gt;</code> 接口、<code>IComparer&lt;T&gt;</code> 接口等知识盲点进行梳理。总而言之，排序需要关注的是 <code>ICompareable</code>/<code>ICompareable&lt;T&gt;</code> 接口、<code>IComparer&lt;T&gt;</code> 接口，去重需要关注的是 <code>IEqualityComparer&lt;T&gt;</code> 接口。好了，今天的这只蝴蝶就飞到这里，欢迎大家在博客中留言，谢谢大家！</p>

            </div>

            
            
            
<div class="copyright s-card">
  <div class="title">
    <span class="post-name">一道 HashSet 面试题引发的蝴蝶效应</span>
    
    <a :href="http://localhost:1313/posts/3411909634/" class="post-link" target="_blank">
      http://localhost:1313/posts/3411909634/
    </a>
    
  </div>
  <div class="post-meta">
    <div class="meta-item">
      <span class="tip">作者</span>
      <span class="name">飞鸿踏雪</span>
    </div>
    
    <div class="meta-item">
      <span class="tip">发布于</span>
      <span class="name">2020-10-20</span>
    </div>
    
    
    <div class="meta-item">
      <span class="tip">更新于</span>
      <span class="name">2020-10-20</span>
    </div>
    
    
    <div class="meta-item cc">
      <span class="tip">许可协议</span>
      <a class="name" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans" target="_blank">
        CC BY-NC-SA 4.0
      </a>
    </div>
    
  </div>
  <span class="meta-tip">署名-非商业性使用-相同方式共享 4.0 国际</span>
</div>

            

            
            <div class="other-meta">
                <div class="all-tags">
                    
                    
                    <a href="/tags/hashset" class="tag-item">
                        <i class="iconfont icon-hashtag"></i>
                        <span class="name">HashSet</span>
                    </a>
                    
                    <a href="/tags/%E7%BC%96%E7%A8%8B" class="tag-item">
                        <i class="iconfont icon-hashtag"></i>
                        <span class="name">编程</span>
                    </a>
                    
                    <a href="/tags/%E9%9D%A2%E8%AF%95" class="tag-item">
                        <i class="iconfont icon-hashtag"></i>
                        <span class="name">面试</span>
                    </a>
                    
                    <a href="/tags/%E6%BA%90%E7%A0%81" class="tag-item">
                        <i class="iconfont icon-hashtag"></i>
                        <span class="name">源码</span>
                    </a>
                    
                    
                </div>
                <a href="https://eqnxweimkr5.feishu.cn/share/base/form/shrcnCXCPmxCKKJYI3RKUfefJre" 
                   class="report" 
                   target="_blank">
                    <i class="iconfont icon-report"></i>
                    反馈与投诉
                </a>
            </div>

            
            
<div class="reward">
  <div class="reward-btn" onclick="document.getElementById('rewardModal').style.display='block'">
    <i class="iconfont icon-reward"></i>
    <span class="text">赞赏博主</span>
  </div>

  
  <div id="rewardModal" class="modal" style="display: none;">
    <div class="modal-mask" onclick="document.getElementById('rewardModal').style.display='none'"></div>
    <div class="modal-container">
      <div class="modal-header">
        <span class="modal-title">
          <i class="iconfont icon-reward"></i>
          赞赏博主
        </span>
        <span class="modal-close" onclick="document.getElementById('rewardModal').style.display='none'">
          <i class="iconfont icon-close"></i>
        </span>
      </div>
      
      <div class="modal-content">
        <div class="reward-card">
          <span class="thank">🙏 感谢您赐予我前进的力量</span>
          <div class="qr">
            
            <a href="/images/reward/wechat.jpg" class="qr-img" target="_blank">
              <img src="/images/reward/wechat.jpg" alt="微信" />
              <span class="tip">
                <i class="iconfont icon-wechat-pay"></i>
                微信
              </span>
            </a>
            
            
            
            <a href="/images/reward/alipay.jpg" class="qr-img" target="_blank">
              <img src="/images/reward/alipay.jpg" alt="支付宝" />
              <span class="tip">
                <i class="iconfont icon-alipay"></i>
                支付宝
              </span>
            </a>
            
          </div>
          
          <div class="all-list s-card hover">
            <span class="title">全部赞赏者名单</span>
            <span class="tip">赞赏金额将全部用于开源项目维护，以及服务器、域名及各类云服务的开销</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 1000;
}

.modal-mask {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1001;
}

.modal-container {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  max-width: 430px;
  width: 90%;
  background: var(--main-card-background);
  border-radius: 8px;
  padding: 20px;
  z-index: 1002;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.modal-close {
  cursor: pointer;
}

 
.reward {
  position: relative;
  display: flex;
  justify-content: center;
  width: max-content;
  margin: 1rem auto;
  user-select: none;
}

.reward-btn {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: center;
  height: 40px;
  width: 120px;
  border-radius: 8px;
  color: #fff;
  background-color: var(--main-color-red);
  transition: box-shadow 0.5s;
  cursor: pointer;
}

 
</style>



            
            

            
            
  
  
  
  
  <div class="related-post">
    <div class="title">
      <span class="name">
        <i class="iconfont icon-star"></i>
        相关推荐
      </span>
      
      <span class="shuffle" onclick="window.location.href='\/posts\/interface-mock-implemention-using-mock.js-in-vue.js\/'">
        随便逛逛
      </span>
      
    </div>

    
    







<div class="post-lists">
    
    <article class="post-item s-card simple" 
             style="animation-delay: 0.4s"
             onclick="window.location.href='\/posts\/2637069146\/'">
        
        
        
        
        <div class="post-content">
            
            

            
            <span class="post-title">低代码，想说爱你不容易</span>

            
            
            <span class="post-desc">本文探讨了“低代码”这一热门话题的发展现状、国内外趋势以及产品形态。指出“低代码”产品主要包括表单生成、工作流生成、协同工作和服务聚合等形态。在对低代码研发痛点的讨论中，强调了多人协作困难、表达能力不足、变量混乱和动态计算等问题，同时提及了黑盒子问题和事件顺序的不确定性。最后，强调了对技术人员学习通用知识和技能的重要性，警示不要盲目追求“低代码”而应注重个人技术积累。</span>
            

            
            
        </div>
    </article>
    
    <article class="post-item s-card simple" 
             style="animation-delay: 0.4s"
             onclick="window.location.href='\/posts\/semantic-kernel-mcp-agent-context-enhanced-exploration\/'">
        
        
        
        
        <div class="post-content">
            
            

            
            <span class="post-title">Semantic Kernel × MCP：智能体的上下文增强探索</span>

            
            
            <span class="post-desc">本文深入探讨了 MCP（模型上下文协议），由 Anthropic 设计的开放协议，它如同 AI 领域的 USB 接口，旨在通过统一接口解决大模型连接不同数据源和工具的问题。文章详细介绍了 MCP 的架构、核心角色、工作原理以及如何与 Semantic Kernel 集成，为 .NET 开发者提供高效接入社区 MCP 服务器的方法，减少重复性平台对接工作。此外，还展示了 MCP 在操作浏览器、访问文件系统等场景中的应用效果，并探讨了其局限性及未来发展方向。在 AI 技术快速发展的背景下，MCP 的出现为实现 AI 模型的 “万物互联” 提供了可能，值得开发者关注与探索。</span>
            

            
            
        </div>
    </article>
    
</div>

<style>
.post-lists {
    width: 100%;
}

.post-lists .post-item {
    padding: 0!important;
    display: flex;
    margin-bottom: 1rem;
    animation: fade-up 0.6s backwards;
    cursor: pointer;
    overflow: hidden;
    height: 200px;
}

.post-lists .post-item .post-cover {
    flex: 0 0 35%;
    overflow: hidden;
    transform: translateZ(0);
}

.post-lists .post-item .post-cover img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform-origin: center center;
    transition: transform 0.5s ease-out, filter 0.5s ease-out;
    backface-visibility: hidden;
}

.post-lists .post-item .post-content {
    flex: 1;
    padding: 1.6rem 2rem;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.post-lists .post-item .post-category {
    display: flex;
    flex-wrap: wrap;
    width: 100%;
    color: var(--main-font-second-color);
    font-size: 14px;
}

.post-lists .post-item .post-category .cat-name {
    display: flex;
    flex-direction: row;
    align-items: center;
}

.post-lists .post-item .post-category .cat-name .iconfont {
    opacity: 0.8;
    margin-right: 6px;
    color: var(--main-font-second-color);
}

.post-lists .post-item .post-category .top {
    margin-left: 12px;
    color: var(--main-color);
}

.post-lists .post-item .post-category .top .iconfont {
    opacity: 0.8;
    color: var(--main-color);
}

.post-lists .post-item .post-title {
    font-size: 20px;
    line-height: 30px;
    font-weight: bold;
    margin: 0.6rem 0;
    transition: color 0.3s;
    display: -webkit-box;
    overflow: hidden;
    word-break: break-all;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 2;
}

.post-lists .post-item .post-desc {
    margin-top: -0.4rem;
    margin-bottom: 0.8rem;
    opacity: 0.8;
    line-height: 30px;
    display: -webkit-box;
    overflow: hidden;
    word-break: break-all;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 2;
}

.post-lists .post-item .post-meta {
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
    color: var(--main-font-second-color);
}

.post-lists .post-item .post-tags {
    display: flex;
    flex-wrap: wrap;
    opacity: 0.8;
    margin-right: 20px;
    overflow: hidden;
    mask: linear-gradient(90deg, #fff 0, #fff 90%, hsla(0,0%,100%,.6) 95%, hsla(0,0%,100%,0) 100%);
}

.post-lists .post-item .post-tags .tags-name {
    display: flex;
    flex-direction: row;
    align-items: center;
    margin-right: 12px;
    white-space: nowrap;
    transition: color 0.3s;
}

.post-lists .post-item .post-time {
    opacity: 0.6;
    font-size: 13px;
    white-space: nowrap;
}

 
.post-lists .post-item:hover .post-cover img {
    filter: brightness(.8);
    transform: scale(1.05);
}

.post-lists .post-item:hover .post-title {
    color: var(--main-color);
}

.post-lists .post-item:active {
    transform: scale(0.98);
}

 
.post-lists .post-item.cover-left {
    flex-direction: row;
}

.post-lists .post-item.cover-right {
    flex-direction: row-reverse;
}

.post-lists .post-item.cover-both:nth-child(odd) {
    flex-direction: row;
}

.post-lists .post-item.cover-both:nth-child(even) {
    flex-direction: row-reverse;
}

 
.post-lists.layout-grid {
    display: grid;
    grid-template-columns: repeat(var(--grid-columns, 2), 1fr);
    gap: var(--grid-gap, 1rem);
}

.post-lists.layout-grid .post-item {
    margin: 0;
    flex-direction: column;
    height: auto;
}

.post-lists.layout-grid .post-item .post-cover {
    flex: none;
    width: 100%;
    height: 225px;
}

 
@media (max-width: 768px) {
    .post-lists .post-item {
        flex-direction: column;
        height: auto;
    }

    .post-lists .post-item .post-cover {
        flex: none;
        width: 100%;
        height: 200px;
    }

    .post-lists .post-item.cover-left,
    .post-lists .post-item.cover-right,
    .post-lists .post-item.cover-both {
        flex-direction: column !important;
    }

    .post-lists.layout-grid {
        grid-template-columns: 1fr;
    }

    .post-lists .post-item .post-tags {
        flex-wrap: nowrap;
    }
}

 
.post-lists .post-item .simple {
    animation: none;
    padding: 0.5rem 1.4rem !important;
    background-color: var(--main-card-second-background);
    height: auto;
    margin-bottom: 0.5rem;
}

.post-lists .post-item .simple .post-content {
    padding: 0.5rem 0;
}

.post-lists .post-item .simple .post-title {
    margin: 0;
    font-size: 16px;
}

.post-lists .post-item .simple .post-desc {
    margin: 0.3rem 0 0 0;
    font-size: 14px;
    opacity: 0.6;
}
</style> 
  </div>
  


<style>
.related-post {
  margin-top: 1rem;
}

.related-post .title {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: space-between;
  width: 100%;
  margin: 3rem 0 1rem 0;
  padding: 0 6px;
}

.related-post .title .name {
  display: flex;
  align-items: center;
  font-size: 24px;
  font-weight: bold;
}

.related-post .title .name .iconfont {
  font-size: 26px;
  font-weight: normal;
  margin-right: 8px;
}

.related-post .title .shuffle {
  opacity: 0.6;
  font-size: 14px;
  transition: color 0.3s, opacity 0.3s;
  cursor: pointer;
}

.related-post .title .shuffle:hover {
  opacity: 1;
  color: var(--main-color);
}
</style>


            
            <div id="comments">
                
<div id="main-comment" class="comment">
    <div v-if="!fill" class="title">
        <span class="name">
            <i class="iconfont icon-chat"></i>
            评论
        </span>
        <span class="tool"> 隐私政策 </span>
    </div>
    <link rel="stylesheet" href="https://unpkg.com/@waline/client@v3/dist/waline.css"/>
<div id="waline" class="waline-container"></div>
<style>
    .waline-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
    .waline-container .vcount {
        color: var(--card-text-color-main);
    }
</style>


    <script type="module">
        import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js';
        init({
            el: '#waline',
            serverURL: 'https:\/\/waline.yuanpei.me\/',
            lang: 'zh',
            dark: 'auto',
            path: window.location.href,
            requiredMeta: ['nick','mail'],
            emoji: [
                '//unpkg.com/@waline/emojis@1.2.0/weibo'
            ],
            reaction: false,
        });
      </script>


</div>

            </div>
        </article>
        
        <aside class="main-aside"><div class="sticky"> 
<div class="aside-countdown s-card weidgets">
  <div class="card-title">
    <i class="fas fa-hourglass-half"></i>
    <span>倒计时</span>
  </div>
  <div class="card-content">
    
  </div>
</div> 

<div class="tags-cloud s-card weidgets">
  <div class="title">
    <i class="iconfont icon-hashtag"></i>
    <span class="title-name">热门标签</span>
  </div>
  <div class="all-tags">
    
  </div>
  <a href="/tags" class="more-tags">查看全部</a>
</div>



<div class="tags-cloud s-card weidgets">
    <div class="title">
        <i class="iconfont icon-hashtag"></i>
        <span class="title-name">日历</span>
    </div>
    <div class="all-tags">
        <img id="calendar-cover" 
             src="https://img.owspace.com/Public/uploads/Download/2025/0401.jpg" 
             style="object-fit: cover; width: 100%; height: 100%; opacity: 0; transition: opacity 0.3s;"
             onload="this.style.opacity = 1"
             
             alt="calendar cover" />
    </div>
</div>

<style>
.all-tags {
    min-height: 200px;  
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const eleImg = document.querySelector("#calendar-cover");
    const getImageUrl = (date) => {
        const currentYear = date.getFullYear();
        const currentMonth = date.getMonth() + 1;
        const currentDate = date.getDate();
        
        const formattedMonth = currentMonth < 10 ? `0${currentMonth}` : currentMonth;
        const formattedDate = currentDate < 10 ? `0${currentDate}` : currentDate;
        return `https://img.owspace.com/Public/uploads/Download/${currentYear}/${formattedMonth}${formattedDate}.jpg`
    }

    
    if (document.location.pathname.startsWith('/posts')) {
        const publishDate = eleImg.dataset.publishDate;
        if (publishDate) {
            eleImg.src = getImageUrl(new Date(publishDate));
        }
    }
});
</script><div class="site-data s-card weidgets">
    <div class="title">
      <i class="iconfont icon-chart"></i>
      <span class="title-name">站点数据</span>
    </div>
    <div class="all-data">
      <div class="data-item">
        <span class="name">
          <i class="iconfont icon-article"></i>
          文章总数
        </span>
        <span class="num">277 篇</span>
      </div>
      <div class="data-item">
        <span class="name">
          <i class="iconfont icon-date"></i>
          建站天数
        </span>
        <span class="num">200 天</span>
      </div>
      <div class="data-item">
        <span class="name">
          <i class="iconfont icon-visibility"></i>
          总访问量
        </span>
        <span class="num" id="busuanzi_value_site_pv">0</span>
      </div>
      <div class="data-item">
        <span class="name">
          <i class="iconfont icon-account"></i>
          总访客数
        </span>
        <span class="num" id="busuanzi_value_site_uv">0</span>
      </div>
    </div>
  </div></div>
  </aside>
  <style>
  .main-aside {
    padding-left: 1rem;
    display: flex;
    flex-direction: column;
    animation: fade-up 0.6s 0.3s backwards;
    .weidgets {
      padding: 18px;
      margin-bottom: 1rem;
      :deep(.title) {
        margin-bottom: 12px;
        font-weight: bold;
        display: flex;
        align-items: center;
        opacity: 0.75;
        .iconfont {
          opacity: 0.6;
          margin-right: 6px;
        }
        .title-name {
          opacity: 0.8;
        }
      }
    }
    .sticky {
      position: sticky;
      top: calc(60px + 1rem);
      .weidgets {
        animation: fade-up 0.6s 0.4s backwards;
        &:last-child {
          margin-bottom: 0;
        }
      }
    }
  }
  </style>
  
    </div>
</div>

<style>
 
:root {
  --code-bg: #fff;
  --code-border: #e1e4e8;
  --code-line-number-color: #8b949e;
  --code-line-number-border: #e1e4e8;
  --code-header-bg: #f6f8fa;
  --code-header-color: #424242;
  --code-button-hover: #f3f4f6;
}

 
@media (prefers-color-scheme: dark) {
  :root {
    --code-bg: #0d1117;
    --code-border: #30363d;
    --code-line-number-color: #8b949e;
    --code-line-number-border: #30363d;
    --code-header-bg: #161b22;
    --code-header-color: #c9d1d9;
    --code-button-hover: #21262d;
  }
}

.highlight {
  position: relative;
  background: var(--code-bg);
  border: 1px solid var(--code-border);
  border-radius: 6px;
}

 
.highlight-header {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2.2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--code-header-bg);
  border-bottom: 1px solid var(--code-border);
  border-radius: 6px 6px 0 0;
  padding: 0 0.5rem;
}

 
.highlight-info {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding-left: 0.5rem;
  color: var(--code-header-color);
  font-size: 0.75rem;
}

 
.highlight-lang {
  padding: 0.2rem 0.5rem;
  border-radius: 3px;
  background: var(--code-bg);
  color: var(--code-header-color);
}

 
.copy-button {
  padding: 0.2rem 0.8rem;
  font-size: 0.75rem;
  color: var(--code-header-color);
  background: var(--code-bg);
  border: 1px solid var(--code-border);
  border-radius: 3px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.copy-button:hover {
  background: var(--code-button-hover);
}

.copy-button.copied {
  color: #1a7f37;
  border-color: #1a7f37;
}

@media (prefers-color-scheme: dark) {
  .copy-button.copied {
    color: #7ee787;
    border-color: #7ee787;
  }
}

 
.highlight-content {
  display: flex;
  width: 100%;
  margin-top: 2.2rem;  
}

 
.line-numbers {
  padding: 1rem 0;
  min-width: 3.5em;
  text-align: right;
  color: var(--code-line-number-color);
  border-right: 1px solid var(--code-line-number-border);
  user-select: none;
  background: var(--code-header-bg);
}

.line-numbers span {
  display: block;
  padding-right: 1rem;
  line-height: 1.5;
  font-size: 0.875rem;
  font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
}

 
.highlight pre {
  flex: 1;
  margin: 0;
  padding: 1rem 0;
  overflow-x: auto;
  background-color: var(--code-bg);;
}

.highlight pre code {
  padding: 0 1rem;
  display: block;
  font-size: 0.875rem;
  line-height: 1.5;
  font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
}

 
.highlight pre::-webkit-scrollbar {
  height: 8px;
}

.highlight pre::-webkit-scrollbar-thumb {
  background: var(--code-border);
  border-radius: 4px;
}

.highlight pre::-webkit-scrollbar-track {
  background: var(--code-header-bg);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  
  hljs.highlightAll();

  document.querySelectorAll('pre > code').forEach((codeBlock) => {
    const pre = codeBlock.parentElement;
    const container = document.createElement('div');
    container.className = 'highlight';
    pre.parentNode.insertBefore(container, pre);

    
    const language = codeBlock.getAttribute('data-lang') || codeBlock.className.match(/language-(\w+)/)?.[1] || 'plaintext';

    
    const header = document.createElement('div');
    header.className = 'highlight-header';
    
    
    const info = document.createElement('div');
    info.className = 'highlight-info';
    
    
    const lang = document.createElement('span');
    lang.className = 'highlight-lang';
    lang.textContent = language;
    info.appendChild(lang);
    
    
    const lines = codeBlock.innerHTML.trim().split('\n');
    const lineCount = document.createElement('span');
    lineCount.textContent = `${lines.length} 行`;
    lineCount.style.display = 'none';
    info.appendChild(lineCount);
    
    header.appendChild(info);

    
    const copyButton = document.createElement('button');
    copyButton.className = 'copy-button';
    copyButton.textContent = '复制';
    header.appendChild(copyButton);

    
    const content = document.createElement('div');
    content.className = 'highlight-content';

    
    const lineNumbers = document.createElement('div');
    lineNumbers.className = 'line-numbers';
    lineNumbers.innerHTML = lines.map((_, i) => `<span>${i + 1}</span>`).join('');

    content.appendChild(lineNumbers);
    content.appendChild(pre);

    container.appendChild(header);
    container.appendChild(content);

    
    copyButton.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(codeBlock.textContent);
        copyButton.textContent = '已复制';
        copyButton.classList.add('copied');
        setTimeout(() => {
          copyButton.textContent = '复制';
          copyButton.classList.remove('copied');
        }, 2000);
      } catch (err) {
        console.error('复制失败:', err);
        copyButton.textContent = '复制失败';
      }
    });
  });
});
</script>

        </main>

        <div class="footer-link">
    
    <div class="footer-bar">
      <span class="site-title">元视角</span>
      <span class="site-desc">纵有疾风起，人生不言弃</span>
      <a href="/" class="to-home">了解更多</a>
    </div>
    
  
    <div class="footer-social">
      
      <a href="https://github.com/yourusername" target="_blank" class="social-link">
        <i class="iconfont icon-github"></i>
      </a>
      
      <a href="https://twitter.com/yourusername" target="_blank" class="social-link">
        <i class="iconfont icon-weibo"></i>
      </a>
      
  
      <div class="logo" title="返回顶部" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
        <img src="/images/icons8-stellar-128.png" alt="author" class="author" />
      </div>
  
      
      <a href="mailto:qinyuanpei@163.com" target="_blank" class="social-link">
        <i class="iconfont icon-email"></i>
      </a>
      
      <a href="https://space.bilibili.com/yourid" target="_blank" class="social-link">
        <i class="iconfont icon-douban"></i>
      </a>
      
    </div>
  
    <div class="footer-sitemap">
      
      <div class="sitemap-item">
        <span class="title">博客</span>
        <div class="links">
          
          <a href="/"  class="link-text">
            近期文章
          </a>
          
          <a href="/categories"  class="link-text">
            全部分类
          </a>
          
          <a href="/tags"  class="link-text">
            全部标签
          </a>
          
          <a href="/archives"  class="link-text">
            文章归档
          </a>
          
        </div>
      </div>
      
      <div class="sitemap-item">
        <span class="title">项目</span>
        <div class="links">
          
          <a href="https://example1.com" target="_blank" class="link-text">
            项目1
          </a>
          
          <a href="https://example2.com" target="_blank" class="link-text">
            项目2
          </a>
          
          <a href="https://example2.com" target="_blank" class="link-text">
            项目3
          </a>
          
          <a href="https://example2.com" target="_blank" class="link-text">
            项目4
          </a>
          
        </div>
      </div>
      
      <div class="sitemap-item">
        <span class="title">专栏</span>
        <div class="links">
          
          <a href="https://blog.csdn.net/qinyuanpei/category_10852603.html" target="_blank" class="link-text">
            .NET 源代码探案系列
          </a>
          
          <a href="https://blog.csdn.net/qinyuanpei/category_7444699.html" target="_blank" class="link-text">
            Python 数据挖掘系列
          </a>
          
          <a href="https://blog.csdn.net/qinyuanpei/category_11484903.html" target="_blank" class="link-text">
            分布式丛林探险系列
          </a>
          
          <a href="https://blog.csdn.net/qinyuanpei/category_1708629.html" target="_blank" class="link-text">
            Unity3D 游戏开发系列
          </a>
          
        </div>
      </div>
      
      <div class="sitemap-item">
        <span class="title">页面</span>
        <div class="links">
          
          <a href="/guest"  class="link-text">
            畅所欲言
          </a>
          
          <a href="/books"  class="link-text">
            阅读记录
          </a>
          
          <a href="/movies"  class="link-text">
            观影记录
          </a>
          
          <a href="/musics"  class="link-text">
            听歌记录
          </a>
          
        </div>
      </div>
      
      <div class="sitemap-item">
        <span class="title">友情链接</span>
        <div class="links">
          
          <a href="https://blog.zhheo.com/"  class="link-text">
            张洪
          </a>
          
          <a href="https://blog.zhheo.com/"  class="link-text">
            张洪
          </a>
          
          <a href="https://blog.zhheo.com/"  class="link-text">
            张洪
          </a>
          
          <a href="https://blog.zhheo.com/"  class="link-text">
            更多
          </a>
          
        </div>
      </div>
      
    </div>
  </div><footer id="main-footer" class="main-footer">
    <div class="footer-content">
        <div class="footer-copyright">
            <span class="time" data-v-6001e979="">@ 2014 - 2025 By </span>
            <a href="https://www.imsyy.top" class="author link" target="_blank">
                飞鸿踏雪
            </a>
            
            
        </div>
        <div class="meta">
            <a class="power link" href="https://vitepress.dev/" target="_blank">
                <span class="by">Powered by</span>
                <span class="name">Hugo</span>
            </a>
            <a class="theme link" href="/pages/theme">
                <span class="name">主题</span>
            </a>
            <a class="rss link" href="https://blog.imsyy.top/rss.xml" target="_blank">
                <i class="iconfont icon-rss"></i>
                <span class="name" data-v-6001e979="">订阅</span>
            </a>
            <a class="cc link" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans" target="_blank">
                <i class="iconfont icon-line"></i>
                <i class="iconfont icon-by-line"></i>
                <i class="iconfont icon-nc-line"></i><i
                    class="iconfont icon-nd-line"></i>
            </a>
        </div>
    </div>
</footer>

<script src="/js/search.min.f2af2dfa3be20e8e7e8c8989bab508289b71bf3730bc6e352738f2084973a1ab.js"></script>
<script>
    
    document.addEventListener('DOMContentLoaded', () => {
        Search.init();
    });
</script>


<script src="/js/theme.min.df71ca7373c5884a4022a354b524ddee31ff8069b6ff5151b5950296b2d3a7a8.js"></script>



<script src="/js/mobile-menu.min.a6c5ea25099e55c871ee73532ed859d8db9223b277b6f3eb13126a95df5cec60.js"></script>



<script src="/js/fancybox.min.05067c092bcbcfb5b923fec5d4e9b0544621c0831a707be573e3f8ce91a33d8e.js"></script><div class="modal search-modal" id="searchModal">
  <div class="modal-container">
    <div class="modal-header">
      <div class="modal-title">
        <i class="iconfont icon-search"></i>
        <span>全局搜索</span>
      </div>
      <div class="modal-close">
        <i class="iconfont icon-close"></i>
      </div>
    </div>

    <div class="search-container">
      <div class="search-box">
        <input 
          type="text" 
          id="searchInput"
          placeholder="想要搜点什么" 
          autocomplete="off"
          autofocus
        >
      </div>

      <div class="search-results" id="searchResults">
        <div class="no-result" id="noResult" style="display: none;">
          <i class="iconfont icon-search-empty"></i>
          <span class="text">搜索结果为空</span>
        </div>
        <div class="search-list" id="searchList"></div>
      </div>

      <div class="search-stats">
        <span class="text" id="searchStats"></span>
      </div>
    </div>
  </div>
</div>

<style>
.search-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 999;
  display: none;
}

.modal-container {
  position: relative;
  width: 90%;
  max-width: 768px;
  margin: 80px auto;
  background-color: var(--main-card-background);
  border-radius: 12px;
  padding: 1.5rem;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.modal-title {
  display: flex;
  align-items: center;
  font-size: 1.2rem;
  font-weight: bold;
}

.modal-title .iconfont {
  margin-right: 0.5rem;
}

.modal-close {
  cursor: pointer;
  padding: 0.5rem;
}

.search-box input {
  width: 100%;
  outline: none;
  border-radius: 8px;
  font-size: 16px;
  padding: 0.6rem 1rem;
  color: var(--main-font-color);
  font-family: var(--main-font-family);
  border: 1px solid var(--main-card-border);
  background-color: var(--main-card-second-background);
  transition: border-color 0.3s, box-shadow 0.3s;
}

.search-box input:focus {
  border-color: var(--main-color);
  box-shadow: 0 8px 16px -4px var(--main-color-bg);
}

.search-results {
  margin-top: 20px;
  min-height: 300px;
}

.no-result {
  height: 300px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.no-result .iconfont {
  font-size: 40px;
  margin-bottom: 12px;
}

.no-result .text {
  font-size: 18px;
  opacity: 0.6;
}

.search-list .search-item {
  margin-bottom: 12px;
  padding: 1rem;
  border-radius: 8px;
  background-color: var(--main-card-second-background);
  cursor: pointer;
  transition: transform 0.3s;
}

.search-list .search-item:hover {
  transform: translateY(-2px);
}

.search-item .title {
  font-size: 16px;
  margin-bottom: 6px;
}

.search-item .content {
  color: var(--main-font-second-color);
  font-size: 14px;
  margin-top: 8px;
}

.search-stats {
  margin-top: 1rem;
  font-size: 14px;
  color: var(--main-font-second-color);
}

.highlight {
  color: var(--main-color);
  background: transparent;
}
</style> 
    </body>
</html> 