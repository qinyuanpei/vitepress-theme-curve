<!DOCTYPE html>
<html lang="zh-cn"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    
    <title>使用 HttpMessageHandler 实现 HttpClient 请求管道自定义 - 元视角</title>
    <meta name="description" content="博客园上介绍了利用 HttpMessageHandler 实现 Http 请求模拟的方案，探讨了HttpMessageHandler在Http请求管道中的作用和实现方式。讨论了HttpMessageHandler与DelegatingHandler的区别，以及如何自定义请求管道并展示了日志记录、请求重试和接口模拟的应用。通过示例展示了如何使用HttpMessageHandler实现这些功能，最后总结了HttpMessageHandler在扩展性、认证头处理等方面的应用。整体内容深入浅出地介绍了HttpMessageHandler的功能和实践。">
    
    
    <link rel="shortcut icon" href="" type="image/x-icon">
    
    
    <meta property="og:title" content="使用 HttpMessageHandler 实现 HttpClient 请求管道自定义">
    <meta property="og:description" content="博客园上介绍了利用 HttpMessageHandler 实现 Http 请求模拟的方案，探讨了HttpMessageHandler在Http请求管道中的作用和实现方式。讨论了HttpMessageHandler与DelegatingHandler的区别，以及如何自定义请求管道并展示了日志记录、请求重试和接口模拟的应用。通过示例展示了如何使用HttpMessageHandler实现这些功能，最后总结了HttpMessageHandler在扩展性、认证头处理等方面的应用。整体内容深入浅出地介绍了HttpMessageHandler的功能和实践。">
    <meta property="og:type" content="article">
    <meta property="og:url" content="http://localhost:1313/posts/2070070822/">
    
    
    <link rel="stylesheet" href="/css/style.css">
    
    
    <link rel="stylesheet" href="/scss/main.min.e8ab63dd8b65ff54276df15e9ceca94e1d74b1c6c9a53ae610da3aa7e126e5d4.css">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_3159629_2j0vwz8wd1k.css">
    
    
    <script src="/js/banner.js" defer></script>
    
    
    
    

    <link crossorigin="" rel="preconnect" href="https://s1.hdslb.com">
    <link crossorigin="" rel="preconnect" href="https://mirrors.sustech.edu.cn">
    <link crossorigin="anonymous" rel="stylesheet" href="https://s1.hdslb.com/bfs/static/jinkela/long/font/regular.css">
    <link crossorigin="anonymous" rel="stylesheet" href="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/lxgw-wenkai-screen-webfont/1.7.0/style.css">
    <link crossorigin="anonymous" rel="stylesheet" href="https://cdn2.codesign.qq.com/icons/g5ZpEgx3z4VO6j2/latest/iconfont.css">
    <link rel="preconnect" href="https://use.sevencdn.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link crossorigin="anonymous" href="https://use.sevencdn.com/css2?family=Fira+Code:wght@300..700&amp;display=swap" rel="stylesheet">
    <link href="https://X5EBEZB53I-dsn.algolia.net" rel="preconnect" crossorigin="">
</head> <body><div class="background patterns">
    
    <div class="bg-mask"></div>
    
    
    <div class="bg-image" style="background-image: url('https://tuapi.eees.cc/api.php?category=%7bdongman,fengjing%7d&amp;type=302')"></div>
    
    
    
</div> 

<style>
    .background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: -2;
      &.patterns {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='192' height='192' viewBox='0 0 192 192'%3E%3Cpath fill='%23494849' fill-opacity='0.08' d='M192 15v2a11 11 0 0 0-11 11c0 1.94 1.16 4.75 2.53 6.11l2.36 2.36a6.93 6.93 0 0 1 1.22 7.56l-.43.84a8.08 8.08 0 0 1-6.66 4.13H145v35.02a6.1 6.1 0 0 0 3.03 4.87l.84.43c1.58.79 4 .4 5.24-.85l2.36-2.36a12.04 12.04 0 0 1 7.51-3.11 13 13 0 1 1 .02 26 12 12 0 0 1-7.53-3.11l-2.36-2.36a4.93 4.93 0 0 0-5.24-.85l-.84.43a6.1 6.1 0 0 0-3.03 4.87V143h35.02a8.08 8.08 0 0 1 6.66 4.13l.43.84a6.91 6.91 0 0 1-1.22 7.56l-2.36 2.36A10.06 10.06 0 0 0 181 164a11 11 0 0 0 11 11v2a13 13 0 0 1-13-13 12 12 0 0 1 3.11-7.53l2.36-2.36a4.93 4.93 0 0 0 .85-5.24l-.43-.84a6.1 6.1 0 0 0-4.87-3.03H145v35.02a8.08 8.08 0 0 1-4.13 6.66l-.84.43a6.91 6.91 0 0 1-7.56-1.22l-2.36-2.36A10.06 10.06 0 0 0 124 181a11 11 0 0 0-11 11h-2a13 13 0 0 1 13-13c2.47 0 5.79 1.37 7.53 3.11l2.36 2.36a4.94 4.94 0 0 0 5.24.85l.84-.43a6.1 6.1 0 0 0 3.03-4.87V145h-35.02a8.08 8.08 0 0 1-6.66-4.13l-.43-.84a6.91 6.91 0 0 1 1.22-7.56l2.36-2.36A10.06 10.06 0 0 0 107 124a11 11 0 0 0-22 0c0 1.94 1.16 4.75 2.53 6.11l2.36 2.36a6.93 6.93 0 0 1 1.22 7.56l-.43.84a8.08 8.08 0 0 1-6.66 4.13H49v35.02a6.1 6.1 0 0 0 3.03 4.87l.84.43c1.58.79 4 .4 5.24-.85l2.36-2.36a12.04 12.04 0 0 1 7.51-3.11A13 13 0 0 1 81 192h-2a11 11 0 0 0-11-11c-1.94 0-4.75 1.16-6.11 2.53l-2.36 2.36a6.93 6.93 0 0 1-7.56 1.22l-.84-.43a8.08 8.08 0 0 1-4.13-6.66V145H11.98a6.1 6.1 0 0 0-4.87 3.03l-.43.84c-.79 1.58-.4 4 .85 5.24l2.36 2.36a12.04 12.04 0 0 1 3.11 7.51A13 13 0 0 1 0 177v-2a11 11 0 0 0 11-11c0-1.94-1.16-4.75-2.53-6.11l-2.36-2.36a6.93 6.93 0 0 1-1.22-7.56l.43-.84a8.08 8.08 0 0 1 6.66-4.13H47v-35.02a6.1 6.1 0 0 0-3.03-4.87l-.84-.43c-1.59-.8-4-.4-5.24.85l-2.36 2.36A12 12 0 0 1 28 109a13 13 0 1 1 0-26c2.47 0 5.79 1.37 7.53 3.11l2.36 2.36a4.94 4.94 0 0 0 5.24.85l.84-.43A6.1 6.1 0 0 0 47 84.02V49H11.98a8.08 8.08 0 0 1-6.66-4.13l-.43-.84a6.91 6.91 0 0 1 1.22-7.56l2.36-2.36A10.06 10.06 0 0 0 11 28 11 11 0 0 0 0 17v-2a13 13 0 0 1 13 13c0 2.47-1.37 5.79-3.11 7.53l-2.36 2.36a4.94 4.94 0 0 0-.85 5.24l.43.84A6.1 6.1 0 0 0 11.98 47H47V11.98a8.08 8.08 0 0 1 4.13-6.66l.84-.43a6.91 6.91 0 0 1 7.56 1.22l2.36 2.36A10.06 10.06 0 0 0 68 11 11 11 0 0 0 79 0h2a13 13 0 0 1-13 13 12 12 0 0 1-7.53-3.11l-2.36-2.36a4.93 4.93 0 0 0-5.24-.85l-.84.43A6.1 6.1 0 0 0 49 11.98V47h35.02a8.08 8.08 0 0 1 6.66 4.13l.43.84a6.91 6.91 0 0 1-1.22 7.56l-2.36 2.36A10.06 10.06 0 0 0 85 68a11 11 0 0 0 22 0c0-1.94-1.16-4.75-2.53-6.11l-2.36-2.36a6.93 6.93 0 0 1-1.22-7.56l.43-.84a8.08 8.08 0 0 1 6.66-4.13H143V11.98a6.1 6.1 0 0 0-3.03-4.87l-.84-.43c-1.59-.8-4-.4-5.24.85l-2.36 2.36A12 12 0 0 1 124 13a13 13 0 0 1-13-13h2a11 11 0 0 0 11 11c1.94 0 4.75-1.16 6.11-2.53l2.36-2.36a6.93 6.93 0 0 1 7.56-1.22l.84.43a8.08 8.08 0 0 1 4.13 6.66V47h35.02a6.1 6.1 0 0 0 4.87-3.03l.43-.84c.8-1.59.4-4-.85-5.24l-2.36-2.36A12 12 0 0 1 179 28a13 13 0 0 1 13-13zM84.02 143a6.1 6.1 0 0 0 4.87-3.03l.43-.84c.8-1.59.4-4-.85-5.24l-2.36-2.36A12 12 0 0 1 83 124a13 13 0 1 1 26 0c0 2.47-1.37 5.79-3.11 7.53l-2.36 2.36a4.94 4.94 0 0 0-.85 5.24l.43.84a6.1 6.1 0 0 0 4.87 3.03H143v-35.02a8.08 8.08 0 0 1 4.13-6.66l.84-.43a6.91 6.91 0 0 1 7.56 1.22l2.36 2.36A10.06 10.06 0 0 0 164 107a11 11 0 0 0 0-22c-1.94 0-4.75 1.16-6.11 2.53l-2.36 2.36a6.93 6.93 0 0 1-7.56 1.22l-.84-.43a8.08 8.08 0 0 1-4.13-6.66V49h-35.02a6.1 6.1 0 0 0-4.87 3.03l-.43.84c-.79 1.58-.4 4 .85 5.24l2.36 2.36a12.04 12.04 0 0 1 3.11 7.51A13 13 0 1 1 83 68a12 12 0 0 1 3.11-7.53l2.36-2.36a4.93 4.93 0 0 0 .85-5.24l-.43-.84A6.1 6.1 0 0 0 84.02 49H49v35.02a8.08 8.08 0 0 1-4.13 6.66l-.84.43a6.91 6.91 0 0 1-7.56-1.22l-2.36-2.36A10.06 10.06 0 0 0 28 85a11 11 0 0 0 0 22c1.94 0 4.75-1.16 6.11-2.53l2.36-2.36a6.93 6.93 0 0 1 7.56-1.22l.84.43a8.08 8.08 0 0 1 4.13 6.66V143h35.02z'%3E%3C/path%3E%3C/svg%3E");
      }
      &.dark {
        &.patterns {
          background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='192' height='192' viewBox='0 0 192 192'%3E%3Cpath fill='%23fcfcfc' fill-opacity='0.08' d='M192 15v2a11 11 0 0 0-11 11c0 1.94 1.16 4.75 2.53 6.11l2.36 2.36a6.93 6.93 0 0 1 1.22 7.56l-.43.84a8.08 8.08 0 0 1-6.66 4.13H145v35.02a6.1 6.1 0 0 0 3.03 4.87l.84.43c1.58.79 4 .4 5.24-.85l2.36-2.36a12.04 12.04 0 0 1 7.51-3.11 13 13 0 1 1 .02 26 12 12 0 0 1-7.53-3.11l-2.36-2.36a4.93 4.93 0 0 0-5.24-.85l-.84.43a6.1 6.1 0 0 0-3.03 4.87V143h35.02a8.08 8.08 0 0 1 6.66 4.13l.43.84a6.91 6.91 0 0 1-1.22 7.56l-2.36 2.36A10.06 10.06 0 0 0 181 164a11 11 0 0 0 11 11v2a13 13 0 0 1-13-13 12 12 0 0 1 3.11-7.53l2.36-2.36a4.93 4.93 0 0 0 .85-5.24l-.43-.84a6.1 6.1 0 0 0-4.87-3.03H145v35.02a8.08 8.08 0 0 1-4.13 6.66l-.84.43a6.91 6.91 0 0 1-7.56-1.22l-2.36-2.36A10.06 10.06 0 0 0 124 181a11 11 0 0 0-11 11h-2a13 13 0 0 1 13-13c2.47 0 5.79 1.37 7.53 3.11l2.36 2.36a4.94 4.94 0 0 0 5.24.85l.84-.43a6.1 6.1 0 0 0 3.03-4.87V145h-35.02a8.08 8.08 0 0 1-6.66-4.13l-.43-.84a6.91 6.91 0 0 1 1.22-7.56l2.36-2.36A10.06 10.06 0 0 0 107 124a11 11 0 0 0-22 0c0 1.94 1.16 4.75 2.53 6.11l2.36 2.36a6.93 6.93 0 0 1 1.22 7.56l-.43.84a8.08 8.08 0 0 1-6.66 4.13H49v35.02a6.1 6.1 0 0 0 3.03 4.87l.84.43c1.58.79 4 .4 5.24-.85l2.36-2.36a12.04 12.04 0 0 1 7.51-3.11A13 13 0 0 1 81 192h-2a11 11 0 0 0-11-11c-1.94 0-4.75 1.16-6.11 2.53l-2.36 2.36a6.93 6.93 0 0 1-7.56 1.22l-.84-.43a8.08 8.08 0 0 1-4.13-6.66V145H11.98a6.1 6.1 0 0 0-4.87 3.03l-.43.84c-.79 1.58-.4 4 .85 5.24l2.36 2.36a12.04 12.04 0 0 1 3.11 7.51A13 13 0 0 1 0 177v-2a11 11 0 0 0 11-11c0-1.94-1.16-4.75-2.53-6.11l-2.36-2.36a6.93 6.93 0 0 1-1.22-7.56l.43-.84a8.08 8.08 0 0 1 6.66-4.13H47v-35.02a6.1 6.1 0 0 0-3.03-4.87l-.84-.43c-1.59-.8-4-.4-5.24.85l-2.36 2.36A12 12 0 0 1 28 109a13 13 0 1 1 0-26c2.47 0 5.79 1.37 7.53 3.11l2.36 2.36a4.94 4.94 0 0 0 5.24.85l.84-.43A6.1 6.1 0 0 0 47 84.02V49H11.98a8.08 8.08 0 0 1-6.66-4.13l-.43-.84a6.91 6.91 0 0 1 1.22-7.56l2.36-2.36A10.06 10.06 0 0 0 11 28 11 11 0 0 0 0 17v-2a13 13 0 0 1 13 13c0 2.47-1.37 5.79-3.11 7.53l-2.36 2.36a4.94 4.94 0 0 0-.85 5.24l.43.84A6.1 6.1 0 0 0 11.98 47H47V11.98a8.08 8.08 0 0 1 4.13-6.66l.84-.43a6.91 6.91 0 0 1 7.56 1.22l2.36 2.36A10.06 10.06 0 0 0 68 11 11 11 0 0 0 79 0h2a13 13 0 0 1-13 13 12 12 0 0 1-7.53-3.11l-2.36-2.36a4.93 4.93 0 0 0-5.24-.85l-.84.43A6.1 6.1 0 0 0 49 11.98V47h35.02a8.08 8.08 0 0 1 6.66 4.13l.43.84a6.91 6.91 0 0 1-1.22 7.56l-2.36 2.36A10.06 10.06 0 0 0 85 68a11 11 0 0 0 22 0c0-1.94-1.16-4.75-2.53-6.11l-2.36-2.36a6.93 6.93 0 0 1-1.22-7.56l.43-.84a8.08 8.08 0 0 1 6.66-4.13H143V11.98a6.1 6.1 0 0 0-3.03-4.87l-.84-.43c-1.59-.8-4-.4-5.24.85l-2.36 2.36A12 12 0 0 1 124 13a13 13 0 0 1-13-13h2a11 11 0 0 0 11 11c1.94 0 4.75-1.16 6.11-2.53l2.36-2.36a6.93 6.93 0 0 1 7.56-1.22l.84.43a8.08 8.08 0 0 1 4.13 6.66V47h35.02a6.1 6.1 0 0 0 4.87-3.03l.43-.84c.8-1.59.4-4-.85-5.24l-2.36-2.36A12 12 0 0 1 179 28a13 13 0 0 1 13-13zM84.02 143a6.1 6.1 0 0 0 4.87-3.03l.43-.84c.8-1.59.4-4-.85-5.24l-2.36-2.36A12 12 0 0 1 83 124a13 13 0 1 1 26 0c0 2.47-1.37 5.79-3.11 7.53l-2.36 2.36a4.94 4.94 0 0 0-.85 5.24l.43.84a6.1 6.1 0 0 0 4.87 3.03H143v-35.02a8.08 8.08 0 0 1 4.13-6.66l.84-.43a6.91 6.91 0 0 1 7.56 1.22l2.36 2.36A10.06 10.06 0 0 0 164 107a11 11 0 0 0 0-22c-1.94 0-4.75 1.16-6.11 2.53l-2.36 2.36a6.93 6.93 0 0 1-7.56 1.22l-.84-.43a8.08 8.08 0 0 1-4.13-6.66V49h-35.02a6.1 6.1 0 0 0-4.87 3.03l-.43.84c-.79 1.58-.4 4 .85 5.24l2.36 2.36a12.04 12.04 0 0 1 3.11 7.51A13 13 0 1 1 83 68a12 12 0 0 1 3.11-7.53l2.36-2.36a4.93 4.93 0 0 0 .85-5.24l-.43-.84A6.1 6.1 0 0 0 84.02 49H49v35.02a8.08 8.08 0 0 1-4.13 6.66l-.84.43a6.91 6.91 0 0 1-7.56-1.22l-2.36-2.36A10.06 10.06 0 0 0 28 85a11 11 0 0 0 0 22c1.94 0 4.75-1.16 6.11-2.53l2.36-2.36a6.93 6.93 0 0 1 7.56-1.22l.84.43a8.08 8.08 0 0 1 4.13 6.66V143h35.02z'%3E%3C/path%3E%3C/svg%3E");
        }
        .cover {
          filter: brightness(0.6);
        }
      }
      .cover {
        width: auto;
        height: auto;
        min-height: 100%;
        opacity: 0;
        transition:
          filter 0.3s,
          opacity 0.3s;
        &.loaded {
          opacity: 1;
        }
      }
    }
    </style>
    
        <header class="main-header">
            <nav class="main-nav up top">
                <div class="nav-all">
                    
                    <div class="left-nav">
                        <div class="more-menu nav-btn" title="更多内容">
                            <i class="iconfont icon-menu"></i><div class="more-menu-panel">
    <div class="menu-list">
        
    </div>
</div> </div>
                        <div class="site-name">
                            元视角
                        </div>
                    </div>
                    
                    
                    <div class="nav-center">
                        <div class="site-menu"><div class="site-menu">
    
    <div class="menu-item">
        <span class="link-btn">文库</span>
        
        <div class="link-child">
            
            <span class="link-child-btn" onclick="window.location.href='\/'">
                
                <i class="iconfont icon-home"></i>
                
                文章列表
            </span>
            
            <span class="link-child-btn" onclick="window.location.href='\/categories'">
                
                <i class="iconfont icon-folder"></i>
                
                全部分类
            </span>
            
            <span class="link-child-btn" onclick="window.location.href='\/tags'">
                
                <i class="iconfont icon-hashtag"></i>
                
                全部标签
            </span>
            
        </div>
        
    </div>
    
    <div class="menu-item">
        <span class="link-btn">书影音</span>
        
        <div class="link-child">
            
            <span class="link-child-btn" onclick="window.location.href='\/reading'">
                
                <i class="iconfont icon-books"></i>
                
                读书
            </span>
            
            <span class="link-child-btn" onclick="window.location.href='\/watching'">
                
                <i class="iconfont icon-tv"></i>
                
                观影
            </span>
            
            <span class="link-child-btn" onclick="window.location.href='\/listening'">
                
                <i class="iconfont icon-music"></i>
                
                听歌
            </span>
            
        </div>
        
    </div>
    
    <div class="menu-item">
        <span class="link-btn">友链</span>
        
        <div class="link-child">
            
            <span class="link-child-btn" onclick="window.location.href='\/friends'">
                
                <i class="iconfont icon-people"></i>
                
                友情链接
            </span>
            
        </div>
        
    </div>
    
    <div class="menu-item">
        <span class="link-btn">关于</span>
        
        <div class="link-child">
            
            <span class="link-child-btn" onclick="window.location.href='\/guestbook'">
                
                <i class="iconfont icon-chat"></i>
                
                留言板
            </span>
            
            <span class="link-child-btn" onclick="window.location.href='\/about'">
                
                <i class="iconfont icon-contacts"></i>
                
                关于本站
            </span>
            
        </div>
        
    </div>
    
</div></div>
                        <span class="site-title">
                            使用 HttpMessageHandler 实现 HttpClient 请求管道自定义
                        </span>
                    </div>
                    
                    
                    <div class="right-nav">
                        
                        <a class="menu-btn nav-btn travellings" title="开往-友链接力" href="https://www.travellings.cn/go.html" target="_blank">
                            <i class="iconfont icon-subway"></i>
                        </a>
                        
                        <div class="menu-btn nav-btn" title="随机前往一篇文章">
                            <i class="iconfont icon-shuffle"></i>
                        </div>
                        
                        <div class="menu-btn nav-btn" title="全站搜索">
                            <i class="iconfont icon-search"></i>
                        </div>
                        
                        <div class="menu-btn nav-btn" id="themeToggle" title="切换主题模式">
                            <i class="iconfont icon-sun" id="themeIcon"></i>
                        </div>
                        
                        <div id="open-control" class="menu-btn nav-btn pc" title="打开中控台">
                            <i class="iconfont icon-dashboard"></i>
                        </div>
                        
                        <div class="to-top menu-btn" title="返回顶部">
                            <div class="to-top-btn">
                                <span class="num">0</span>
                                <i class="iconfont icon-up"></i>
                            </div>
                        </div>
                        
                        <div class="menu-btn nav-btn mobile" title="打开菜单">
                            <i class="iconfont icon-toc"></i>
                        </div>
                    </div>
                </div>
            </nav>
            <div class="mobile-menu">
    <div class="menu-mask"></div>
    <div class="menu-content">
        <div class="menu-header">
            <div class="site-info">
                <div class="site-name">元视角</div>
                <div class="site-description">纵有疾风起，人生不言弃</div>
            </div>
        </div>
        <div class="menu-body">
            
            <div class="menu-group">
                <div class="menu-title">导航</div>
                <div class="menu-list">
                    
                    
                    <a class="menu-item" href="" >
                        
                        <span>文库</span>
                    </a>
                    
                    <a class="menu-item" href="" >
                        
                        <span>书影音</span>
                    </a>
                    
                    <a class="menu-item" href="" >
                        
                        <span>友链</span>
                    </a>
                    
                    <a class="menu-item" href="" >
                        
                        <span>关于</span>
                    </a>
                    
                </div>
            </div>
            
            <div class="menu-group">
                <div class="menu-title">更多</div>
                <div class="menu-list">
                    
                </div>
            </div>
        </div>
    </div>
</div> <div class="modal search-modal" id="searchModal">
  <div class="modal-container">
    <div class="modal-header">
      <div class="modal-title">
        <i class="iconfont icon-search"></i>
        <span>全局搜索</span>
      </div>
      <div class="modal-close">
        <i class="iconfont icon-close"></i>
      </div>
    </div>

    <div class="search-container">
      <div class="search-box">
        <input 
          type="text" 
          id="searchInput"
          placeholder="想要搜点什么" 
          autocomplete="off"
          autofocus
        >
      </div>

      <div class="search-results" id="searchResults">
        <div class="no-result" id="noResult" style="display: none;">
          <i class="iconfont icon-search-empty"></i>
          <span class="text">搜索结果为空</span>
        </div>
        <div class="search-list" id="searchList"></div>
      </div>

      <div class="search-stats">
        <span class="text" id="searchStats"></span>
      </div>
    </div>
  </div>
</div>

<style>
.search-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 999;
  display: none;
}

.modal-container {
  position: relative;
  width: 90%;
  max-width: 768px;
  margin: 80px auto;
  background-color: var(--main-card-background);
  border-radius: 12px;
  padding: 1.5rem;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.modal-title {
  display: flex;
  align-items: center;
  font-size: 1.2rem;
  font-weight: bold;
}

.modal-title .iconfont {
  margin-right: 0.5rem;
}

.modal-close {
  cursor: pointer;
  padding: 0.5rem;
}

.search-box input {
  width: 100%;
  outline: none;
  border-radius: 8px;
  font-size: 16px;
  padding: 0.6rem 1rem;
  color: var(--main-font-color);
  font-family: var(--main-font-family);
  border: 1px solid var(--main-card-border);
  background-color: var(--main-card-second-background);
  transition: border-color 0.3s, box-shadow 0.3s;
}

.search-box input:focus {
  border-color: var(--main-color);
  box-shadow: 0 8px 16px -4px var(--main-color-bg);
}

.search-results {
  margin-top: 20px;
  min-height: 300px;
}

.no-result {
  height: 300px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.no-result .iconfont {
  font-size: 40px;
  margin-bottom: 12px;
}

.no-result .text {
  font-size: 18px;
  opacity: 0.6;
}

.search-list .search-item {
  margin-bottom: 12px;
  padding: 1rem;
  border-radius: 8px;
  background-color: var(--main-card-second-background);
  cursor: pointer;
  transition: transform 0.3s;
}

.search-list .search-item:hover {
  transform: translateY(-2px);
}

.search-item .title {
  font-size: 16px;
  margin-bottom: 6px;
}

.search-item .content {
  color: var(--main-font-second-color);
  font-size: 14px;
  margin-top: 8px;
}

.search-stats {
  margin-top: 1rem;
  font-size: 14px;
  color: var(--main-font-second-color);
}

.highlight {
  color: var(--main-color);
  background: transparent;
}
</style> </header>

        
        <main class="main-layout">



<div class="post">
    <div class="post-meta">
        <div class="meta">
            
            <div class="categories">
                
                
                <a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80" class="cat-item">
                    <i class="iconfont icon-folder"></i>
                    <span class="name">编程语言</span>
                </a>
                
                
            </div>
            
            <div class="tags">
                
                
                <a href="/tags/httpclient" class="tag-item">
                    <i class="iconfont icon-hashtag"></i>
                    <span class="name">HttpClient</span>
                </a>
                
                <a href="/tags/mock" class="tag-item">
                    <i class="iconfont icon-hashtag"></i>
                    <span class="name">Mock</span>
                </a>
                
                <a href="/tags/%E7%AE%A1%E9%81%93" class="tag-item">
                    <i class="iconfont icon-hashtag"></i>
                    <span class="name">管道</span>
                </a>
                
                <a href="/tags/%E6%89%A9%E5%B1%95" class="tag-item">
                    <i class="iconfont icon-hashtag"></i>
                    <span class="name">扩展</span>
                </a>
                
                
            </div>
        </div>
        <h1 class="title">
            使用 HttpMessageHandler 实现 HttpClient 请求管道自定义
        </h1>
        <div class="other-meta">
            
            <span class="meta date">
                <i class="iconfont icon-date"></i>
                2021-04-28
            </span>
            
            <span class="update meta">
                <i class="iconfont icon-time"></i>
                2021-04-28
            </span>
            
            <span class="hot meta">
                <i class="iconfont icon-fire"></i>
                <span id="twikoo_visitors" class="artalk-pv-count">0</span>
            </span>
            
            <span class="chat meta hover" data-scroll-to="comments">
                <i class="iconfont icon-chat"></i>
                <span id="twikoo_comments" class="artalk-comment-count">0</span>
            </span>
        </div>
    </div>
    <div class="post-content">
        <article class="post-article s-card">
            
            
            
            <div class="expired s-card">
                本文发表于 <strong>1430</strong> 天前，其中的信息可能已经事过境迁
            </div>
            

            
<div class="article-gpt s-card">
  <div class="title">
    <span class="name">
      <i class="iconfont icon-robot"></i>
      文章摘要
      <i class="iconfont icon-up"></i>
    </span>
    <span class="logo">FakeGPT</span>
  </div>
  <div class="content s-card">
    <span class="text"></span>
  </div>
  <div class="meta">
    
    
  </div>
</div>
<script src="https://npm.elemecdn.com/typeit@8.7.1/dist/index.umd.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    new TypeIt(".article-gpt .content .text", {
        strings: '博客园上介绍了利用 HttpMessageHandler 实现 Http 请求模拟的方案，探讨了HttpMessageHandler在Http请求管道中的作用和实现方式。讨论了HttpMessageHandler与DelegatingHandler的区别，以及如何自定义请求管道并展示了日志记录、请求重试和接口模拟的应用。通过示例展示了如何使用HttpMessageHandler实现这些功能，最后总结了HttpMessageHandler在扩展性、认证头处理等方面的应用。整体内容深入浅出地介绍了HttpMessageHandler的功能和实践。',
        speed: 10,
        lifeLike: true,
        waitUntilVisible: true,
    }).go();
});
</script>



            
            <div id="page-content" class="markdown-main-style">
                <p>最近，博主偶然间在 <a href="https://www.cnblogs.com">博客园</a> 看到一篇文章：<a href="https://www.cnblogs.com/xfrog/p/14703251.html">ASP.NET Core 扩展库之 Http 请求模拟</a>，它里面介绍了一种利用 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/system.net.http.httpmessagehandler?view=net-5.0">HttpMessageHandler</a> 来实现 Http 请求模拟的方案。在日常工作中，我们总是不可避免地要和第三方的服务或者接口打交道，尤其是当我们需要面对“<strong>联调</strong>”这样一件事情的时候。通常，我们可以通过类似 <a href="https://github.com/ymfe/yapi">YAPI</a> 这样的工具来对尚在开发中的接口进行模拟。可是，因为这种方式会让我们的测试代码依赖于一个外部工具，所以，从严格意义上讲，它其实应该属于“<strong>集成测试</strong>”的范畴。在接触前端开发的过程中，对于其中的 <a href="http://mockjs.com/">Mock.js</a> 印象深刻。故而，当看到 .NET 中有类似实现的时候，好奇心驱使我对其中的核心，即 <code>HttpMessageHandler</code> 产生了浓厚的兴趣。平时，我们更多的是使用 <a href="https://github.com/moq/moq4">Moq</a> 这样的库来模拟某一个对象的行为，而对一个 Http 请求进行模拟，可以说是开天辟地头一遭。带着这些问题出发，就有了今天这篇博客，通过 <code>HttpMessageHandler</code> 实现 <code>HttpClient</code> 请求管道的自定义。</p>
<h1 id="什么是-httpmessagehandler">什么是 HttpMessageHandler？</h1>
<p>相信大家读过我提到的文章以后，都能找到这里面最核心的一个点：<code>HttpMessageHandler</code>。于是，我们今天要面对的第一个问题就是，什么是 <code>HttpMessageHandler</code>？此时，我们需要一张历久弥新的示意图，来自 <a href="https://www.asp.net/media/4071077/aspnet-web-api-poster.pdf">微软官方</a>。这里，我们重点关注的是 <code>DelegatingHandler</code>，它继承自 <code>HttpMessageHandler</code>。通过这张图，我们能够获得哪些信息呢？</p>
<p>我认为，主要有以下几点：<strong>第一，HttpMessageHandler 处于整个 Http 请求管道的第一梯队，每一个路由匹配的请求都会从这里“进入”和“离开”；第二，HttpMessageHandler 可以是全局配置或者针对某个特定的路由，只要这个路由被匹配到就会执行；第三，HttpMessageHandler 可以直接构造 Http 响应并且返回，跳过剩余的管道流程</strong>。不知道大家看到这里会想到什么？坦白讲，我联想到了.NET Core 中的中间件，而唯一不同的地方或许是，中间件是 ASP.NET Core 里的概念，这里则是 ASP.NET Web API 里的概念。尤其是第三点，它对于我们的意义非常重大，因为它，我们才可以做到对一个 Http 请求进行模拟。</p>
<p><img src="https://i.loli.net/2021/04/28/AwLZDdqXc5KERky.png" alt="HttpMessageHandler 与 ASP.NET Web API"></p>
<p>而事实上，在 ASP.NET Web API 的设计中，它是由一组 <code>HttpMessageHandler</code> 经过“首尾相连”而成，这种管道式的设计使得框架本身具有很高的扩展性。虽然，作为一个服务端框架，ASP.NET Web API 最主要的作用是就是“<strong>处理请求、响应回复</strong>”，可具体采用的处理策略会因具体场景的不同而不同。所以，管道式设计的本质，就是让某一个 <code>Handler</code> 只负责某个单一的消息处理功能，在根据具体场景的不同，选择需要的 <code>Handler</code> 并将其串联成一个完整的消息处理通道。而在这里，这个负责单一的消息处理功能的 <code>Handler</code> 其实就是 <code>HttpMessageHandler</code>，因为它不单单可以对请求消息(<strong>HttpRequestMessage</strong>)进行处理，同时还可以对响应消息(<strong>HttpResponseMessage</strong>)进行处理。此时，我们就不难理解 <code>HttpMessageHandler</code> 的定义：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="k">class</span> <span class="nc">HttpMessageHandler</span> <span class="p">:</span> <span class="n">IDisposable</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">HttpMessageHandler</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">Dispose</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="k">virtual</span> <span class="k">void</span> <span class="n">Dispose</span><span class="p">(</span><span class="kt">bool</span> <span class="n">disposing</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">internal</span> <span class="k">virtual</span> <span class="n">HttpResponseMessage</span> <span class="n">Send</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">HttpRequestMessage</span> <span class="n">request</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">      <span class="n">CancellationToken</span> <span class="n">cancellationToken</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">internal</span> <span class="kd">abstract</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">HttpResponseMessage</span><span class="p">&gt;</span> <span class="n">SendAsync</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">HttpRequestMessage</span> <span class="n">request</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">      <span class="n">CancellationToken</span> <span class="n">cancellationToken</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>也许，你会忍不住问这样一个问题：<code>DelegatingHandler</code> 和 <code>HttpMessageHandler</code> 的区别是什么？ 其实，只要你稍微仔细一点，你就会发现，两者最大的区别是 <code>DelegatingHandler</code> 里新增一个叫做 <code>InnerHandler</code> 的成员，它本身就是一个 <code>HttpMessageHandler</code>。所以，聪明的你又联想到什么呢？我想，或许是一个叫做 <code>RequestDelegate</code> 的委托，还记得我们写中间件是一直都少不了的 <code>Next</code> 吗？不得不说，这里越来越有中间件的味道了。你可以立马想到的一件事情是，除了最后一个 <code>Handler</code> 是 <code>HttpMessageHandler</code> 以外，剩下的前面的所有的 <code>Handler</code> 都是 <code>DelegatingHandler</code>。为什么这样说呢？因为前面的 <code>n-1</code> 个 <code>Handler</code> 都需要串联下一个 <code>Handler</code>，只有第 <code>n</code> 个 <code>Handler</code>可以允许短路，所以，大概就相当于 <code>Use()</code> 和 <code>Run()</code> 的区别？</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="k">class</span> <span class="nc">DelegatingHandler</span> <span class="p">:</span> <span class="n">HttpMessageHandler</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">DelegatingHandler</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">DelegatingHandler</span><span class="p">(</span><span class="n">HttpMessageHandler</span> <span class="n">innerHandler</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// InnerHandler是实现管道式设计的关键</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">HttpMessageHandler</span><span class="p">?</span> <span class="n">InnerHandler</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">Dispose</span><span class="p">(</span><span class="kt">bool</span> <span class="n">disposing</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">internal</span> <span class="kd">override</span> <span class="n">HttpResponseMessage</span> <span class="n">Send</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">HttpRequestMessage</span> <span class="n">request</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">      <span class="n">CancellationToken</span> <span class="n">cancellationToken</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">internal</span> <span class="kd">override</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">HttpResponseMessage</span><span class="p">&gt;</span> <span class="n">SendAsync</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">HttpRequestMessage</span> <span class="n">request</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">      <span class="n">CancellationToken</span> <span class="n">cancellationToken</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>所以，此时此刻，你能否为 <code>HttpMessageHandler</code> 下一个清晰的定义呢？我想，或许可以这样理解，一种可以对 请求消息(<strong>HttpRequestMessage</strong>) 和 响应消息(<strong>HttpResponseMessage</strong>) 进行处理，同时多个 <code>HttpMessageHandler</code> 可以组成一个完整的消息处理通道的中间件。屏幕前的你又是如何理解的呢？欢迎大家在评论区留言，留下你对于 <code>HttpMessageHandler</code> 的想法或者认识。</p>
<h1 id="实现自定义请求管道">实现自定义请求管道</h1>
<p>好了，搞清楚 <code>HttpMessageHandler</code> 是什么以后，我们就可以考虑自定义请求管道的实现啦！让我们从一个最简单的示例开始，假设我们这里定义了两个自定义的 <code>Handler</code>，它们分别是： <code>HandlerA</code> 和 <code>HandlerB</code>，我们应该如何将其应用到具体的 <code>HttpClient</code>上呢？</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="c1">// Handler A</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">HandlerA</span> <span class="p">:</span> <span class="n">DelegatingHandler</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">readonly</span> <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">HandlerA</span><span class="p">&gt;</span> <span class="n">_logger</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">HandlerA</span><span class="p">(</span><span class="n">ILogger</span><span class="p">&lt;</span><span class="n">HandlerA</span><span class="p">&gt;</span> <span class="n">logger</span><span class="p">)</span> <span class="p">{</span> <span class="n">_logger</span> <span class="p">=</span> <span class="n">logger</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">override</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">HttpResponseMessage</span><span class="p">&gt;</span> <span class="n">SendAsync</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">HttpRequestMessage</span> <span class="n">request</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">      <span class="n">CancellationToken</span> <span class="n">cancellationToken</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_logger</span><span class="p">.</span><span class="n">LogInformation</span><span class="p">(</span><span class="s">&#34;This is Handler A&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">base</span><span class="p">.</span><span class="n">SendAsync</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Handler B</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">HandlerB</span> <span class="p">:</span> <span class="n">DelegatingHandler</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">readonly</span> <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">HandlerB</span><span class="p">&gt;</span> <span class="n">_logger</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">HandlerB</span><span class="p">(</span><span class="n">ILogger</span><span class="p">&lt;</span><span class="n">HandlerB</span><span class="p">&gt;</span> <span class="n">logger</span><span class="p">)</span> <span class="p">{</span> <span class="n">_logger</span> <span class="p">=</span> <span class="n">logger</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">override</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">HttpResponseMessage</span><span class="p">&gt;</span> <span class="n">SendAsync</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">HttpRequestMessage</span> <span class="n">request</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">      <span class="n">CancellationToken</span> <span class="n">cancellationToken</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_logger</span><span class="p">.</span><span class="n">LogInformation</span><span class="p">(</span><span class="s">&#34;This is Handler B&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">base</span><span class="p">.</span><span class="n">SendAsync</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>这里，我们考虑两种场景，依赖注入 和 非依赖注入。对于依赖注入的场景，我们只需要调用<code>AddHttpMessageHandler()</code>方法按顺序注册即可，不需要处理<code>InnerHandler</code>，这里遵循先注册后使用的原则；对于非依赖注入的场景，需要处理<code>InnerHandler</code>，并在构造<code>HttpClient</code>的时候作为参数传入。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="c1">// 依赖注入</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">services</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ServiceCollection</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">services</span><span class="p">.</span><span class="n">AddTransient</span><span class="p">&lt;</span><span class="n">HandlerA</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl"><span class="n">services</span><span class="p">.</span><span class="n">AddTransient</span><span class="p">&lt;</span><span class="n">HandlerB</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl"><span class="n">services</span><span class="p">.</span><span class="n">AddHttpClient</span><span class="p">(</span><span class="s">&#34;MyClient&#34;</span><span class="p">,</span> <span class="n">options</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">options</span><span class="p">.</span><span class="n">BaseAddress</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Uri</span><span class="p">(</span><span class="s">&#34;https://blog.yuanpei.me/&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">AddHttpMessageHandler</span><span class="p">&lt;</span><span class="n">HandlerA</span><span class="p">&gt;()</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">AddHttpMessageHandler</span><span class="p">&lt;</span><span class="n">HandlerB</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 非依赖注入</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">handler</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HandlerA</span><span class="p">()</span> <span class="p">{</span> <span class="n">InnerHandler</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HandlerB</span><span class="p">()</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HttpClient</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
</span></span></code></pre></div><p>此时，我们就可以得到下面的结果，可以注意到的是，两个<code>Handler</code>的执行顺序与注册顺序一致：</p>
<p><img src="https://i.loli.net/2021/04/29/URNWavrVgyzMAxe.png" alt="Handler执行顺序与注册顺序"></p>
<p>好了，热身环节到此结束！下面，我们来开始实战，这里展示的是 <code>HttpMessageHandler</code> 在日志记录、请求重试 和 接口模拟等方面的应用。</p>
<h2 id="日志记录">日志记录</h2>
<p>对于 Http 请求的日志，我们希望记录请求的Url、Http动词、请求时长等信息，而这一点，在一个大量接入第三方接口的系统或者是以 Http 驱动的微服务架构中，常常是不可或缺的一环，对于我们排查故障、监控服务非常有用。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kd">override</span> <span class="kd">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">HttpResponseMessage</span><span class="p">&gt;</span> <span class="n">SendAsync</span><span class="p">(</span><span class="n">HttpRequestMessage</span> <span class="n">request</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">var</span> <span class="n">correlationId</span> <span class="p">=</span> <span class="n">GetCorrelationId</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">using</span> <span class="p">(</span><span class="n">_logger</span><span class="p">.</span><span class="n">BeginScope</span><span class="p">(</span><span class="s">$&#34;correlationId={correlationId}&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">sw</span> <span class="p">=</span> <span class="n">Stopwatch</span><span class="p">.</span><span class="n">StartNew</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">_logger</span><span class="p">.</span><span class="n">LogInformation</span><span class="p">(</span><span class="s">$&#34;Start Processing HTTP Request {request.Method} {request.RequestUri} [Correlation: {correlationId}]&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="k">base</span><span class="p">.</span><span class="n">Send</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">         <span class="n">_logger</span><span class="p">.</span><span class="n">LogInformation</span><span class="p">(</span><span class="s">$&#34;End Processing HTTP Request in {sw.ElapsedMilliseconds}ms {response.StatusCode}, [Correlation: {correlationId}]&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">response</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// GetCorrelationId</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">string</span> <span class="n">GetCorrelationId</span><span class="p">(</span><span class="n">HttpRequestMessage</span> <span class="n">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="n">TryGetValues</span><span class="p">(</span><span class="s">&#34;X-Correlation-ID&#34;</span><span class="p">,</span> <span class="k">out</span> <span class="kt">var</span> <span class="n">values</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">values</span><span class="p">.</span><span class="n">First</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">var</span> <span class="n">correlationId</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="n">NewGuid</span><span class="p">().</span><span class="n">ToString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">request</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">&#34;X-Correlation-ID&#34;</span><span class="p">,</span> <span class="n">correlationId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">correlationId</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>此时，我们可以得到下面的结果：</p>
<p><img src="https://i.loli.net/2021/04/29/aORFS3ZQEw8pNbT.png" alt="HttpMessageHandler 实现日志记录"></p>
<h2 id="请求重试">请求重试</h2>
<p>我们知道，一个系统中接入的外部因素越多，则整个系统的稳定性越低。而国内的产品通常都喜欢&quot;大而全&quot;的&quot;万物互联&quot;，所以，最实际的问题，其实就是调用一个第三方的接口，如何保证其可靠性。所以，考虑请求的故障恢复就显得非常有意义，为此，我们可以引入<code>Polly</code>，在实现<code>SendAsync()</code>方法的时候，通过<code>Polly</code>中的超时、重试等机制对其做一层包装：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">RetryableHttpMessageHandler</span> <span class="p">:</span> <span class="n">DelegatingHandler</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">readonly</span> <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">RetryableHttpMessageHandler</span><span class="p">&gt;</span> <span class="n">_logger</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">readonly</span> <span class="n">IAsyncPolicy</span><span class="p">&lt;</span><span class="n">HttpResponseMessage</span><span class="p">&gt;</span> <span class="n">_retryPolicy</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">RetryableHttpMessageHandler</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">RetryableHttpMessageHandler</span><span class="p">&gt;</span> <span class="n">logger</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_logger</span> <span class="p">=</span> <span class="n">logger</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_retryPolicy</span> <span class="p">=</span> <span class="n">Policy</span><span class="p">&lt;</span><span class="n">HttpResponseMessage</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">Handle</span><span class="p">&lt;</span><span class="n">HttpRequestException</span><span class="p">&gt;()</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">Or</span><span class="p">&lt;</span><span class="n">TimeoutException</span><span class="p">&gt;()</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">OrResult</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">x</span><span class="p">.</span><span class="n">StatusCode</span> <span class="p">&gt;=</span> <span class="m">400</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">RetryAsync</span><span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span> <span class="p">=&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">_logger</span><span class="p">.</span><span class="n">LogInformation</span><span class="p">(</span><span class="s">$&#34;调用接口异常：{ret.Exception?.Message}，状态码：{ret.Result.StatusCode}, 正在进行第{index}次重试&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">override</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">HttpResponseMessage</span><span class="p">&gt;</span> <span class="n">SendAsync</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">HttpRequestMessage</span> <span class="n">request</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">      <span class="n">CancellationToken</span> <span class="n">cancellationToken</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">_retryPolicy</span><span class="p">.</span><span class="n">ExecuteAsync</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="k">base</span><span class="p">.</span><span class="n">SendAsync</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>同样地，我们这里通过<code>HttpClient</code>来请求指定的接口。因为，下面的接口实际上是不存在的。所以，理论上它会返回<code>404</code>这个状态码。而我们的重试策略是，在发生<code>HttpRequestException</code>或者<code>TimeoutException</code>异常以及 Http 响应的状态码大于 400 时，自动触发 3 次重试。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="n">_clientFactory</span><span class="p">.</span><span class="n">CreateClient</span><span class="p">(</span><span class="s">&#34;ApiMock&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">GetAsync</span><span class="p">(</span><span class="s">&#34;/api/fail&#34;</span><span class="p">);</span>
</span></span></code></pre></div><p>此时，我们可以得到下面的结果：</p>
<p><img src="https://i.loli.net/2021/04/30/OaUyhNF7XYsA8mI.png" alt="HttpMessageHandler 实现请求重试"></p>
<p>可以发现，不多不少刚好是 3 次。除了重试以外，<code>Polly</code>还支持类似超时、断路器等等不同的策略，甚至可以将它们组合起来使用，这些都属于<a href="https://github.com/App-vNext/Polly">Polly</a>的内容，不作为本文的重点内容来讲解，感兴趣的朋友可以查阅这篇文章：<a href="https://www.cnblogs.com/willick/p/polly.html">.NET 开源项目 Polly 介绍</a>。需要说明的是，微软官方提供的 <code>Microsoft.Extensions.Http.Polly</code>，它在<code>IHttpClientBuilder</code>上添加了一个名为<code>AddPolicyHandler()</code>的扩展方法，这里的例子可以被简化为下面这样，它和我们这里举的例子是完全一致的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="c1">// 定义重试策略</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">retryPolicy</span> <span class="p">=</span> <span class="n">Policy</span><span class="p">&lt;</span><span class="n">HttpResponseMessage</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">Handle</span><span class="p">&lt;</span><span class="n">HttpRequestException</span><span class="p">&gt;()</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">Or</span><span class="p">&lt;</span><span class="n">TimeoutException</span><span class="p">&gt;()</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">OrResult</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">x</span><span class="p">.</span><span class="n">StatusCode</span> <span class="p">&gt;=</span> <span class="m">400</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">RetryAsync</span><span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span> <span class="p">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;调用接口异常：{ret.Exception?.Message}，状态码：{ret.Result.StatusCode}, 正在进行第{index}次重试&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 注册HttpClient并指定重试策略</span>
</span></span><span class="line"><span class="cl"><span class="n">services</span><span class="p">.</span><span class="n">AddHttpClient</span><span class="p">(</span><span class="s">&#34;ApiMock&#34;</span><span class="p">,</span> <span class="n">options</span> <span class="p">=&gt;</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">  <span class="n">options</span><span class="p">.</span><span class="n">BaseAddress</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Uri</span><span class="p">(</span><span class="s">&#34;https://blog.yuanpei.me&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">AddPolicyHandler</span><span class="p">(</span><span class="n">retryPolicy</span><span class="p">);</span>
</span></span></code></pre></div><h2 id="接口模拟">接口模拟</h2>
<p>在集成第三方接口时，在双方确定好接口以后，接口消费方会有一段时间的“黒写”时期。因为在接口提供方的接口没有正式提供前，接口消费方始终只能通过“<strong>模拟</strong>”的方式来进行测试。考虑到单元测试对 <a href="https://github.com/ymfe/yapi">YAPI</a> 存在耦合，所以，接口模拟同样是一件意义非凡的事情。这里的思路是利用 <code>HttpMessageHandler</code> 的“<strong>短路</strong>”功能，即构造一个 <code>HttpResponseMessage</code> 并返回。</p>
<p>首先，我们定义一个<code>MockItem</code>类型，它含有两个委托类型的属性<code>RouteSelector</code>和<code>Executor</code>。其中，前者用来匹配路由，而后者则用来处理接口返回值。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">MockItem</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">HttpRequestMessage</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span> <span class="n">RouteSelector</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">HttpRequestMessage</span><span class="p">,</span> <span class="n">HttpResponseMessage</span><span class="p">,</span> <span class="n">Task</span><span class="p">&gt;</span> <span class="n">Executor</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>接下来，我们需要定义相应的<code>Handler</code>，这里是<code>ApiMockHttpMessageHandler</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">ApiMockHttpMessageHandler</span><span class="p">:</span> <span class="n">DelegatingHandler</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">readonly</span> <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">ApiMockHttpMessageHandler</span><span class="p">&gt;</span> <span class="n">_logger</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">readonly</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">MockItem</span><span class="p">&gt;</span> <span class="n">_routes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ApiMockHttpMessageHandler</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">ApiMockHttpMessageHandler</span><span class="p">&gt;</span> <span class="n">logger</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">MockItem</span><span class="p">&gt;</span> <span class="n">routes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_logger</span> <span class="p">=</span> <span class="n">logger</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_routes</span> <span class="p">=</span> <span class="n">routes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">override</span> <span class="kd">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">HttpResponseMessage</span><span class="p">&gt;</span> <span class="n">SendAsync</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">HttpRequestMessage</span> <span class="n">request</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">      <span class="n">CancellationToken</span> <span class="n">cancellationToken</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 匹配路由并调用其Executor属性</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">route</span> <span class="p">=</span> <span class="n">_routes</span><span class="p">.</span><span class="n">FirstOrDefault</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">RouteSelector</span><span class="p">?.</span><span class="n">Invoke</span><span class="p">(</span><span class="n">request</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">route</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HttpResponseMessage</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">await</span> <span class="n">route</span><span class="p">.</span><span class="n">Executor</span><span class="p">?.</span><span class="n">Invoke</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">response</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">base</span><span class="p">.</span><span class="n">Send</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>我们的思路是，对于所有注入到<code>Ioc</code>容器中的<code>MockItem</code>，检查其路由是否匹配，如果路由匹配，则通过其指定的<code>Executor</code>对<code>HttpResponseMessage</code>进行加工并返回。为了更加方便地在<code>Ioc</code>容器中进行注入，我们为<code>IServiceCollection</code>编写了相应的扩展方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">IServiceCollection</span> <span class="n">AddMock</span><span class="p">&lt;</span><span class="n">TReturn</span><span class="p">&gt;(</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span> <span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="kt">string</span> <span class="n">url</span><span class="p">,</span> <span class="n">HttpMethod</span> <span class="n">method</span><span class="p">,</span> <span class="n">TReturn</span> <span class="n">@return</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">var</span> <span class="n">mockItem</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MockItem</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">mockItem</span><span class="p">.</span><span class="n">Executor</span> <span class="p">=</span> <span class="n">BuildExecutor</span><span class="p">&lt;</span><span class="n">TReturn</span><span class="p">&gt;(</span><span class="n">@return</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mockItem</span><span class="p">.</span><span class="n">RouteSelector</span> <span class="p">=</span> <span class="n">BuildRouteSelector</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">services</span><span class="p">.</span><span class="n">AddTransient</span><span class="p">&lt;</span><span class="n">MockItem</span><span class="p">&gt;(</span><span class="n">sp</span> <span class="p">=&gt;</span> <span class="n">mockItem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">IServiceCollection</span> <span class="n">AddMock</span><span class="p">&lt;</span><span class="n">TReturn</span><span class="p">&gt;(</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span> <span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">Func</span><span class="p">&lt;</span><span class="n">HttpRequestMessage</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span> <span class="n">routeSelector</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">Func</span><span class="p">&lt;</span><span class="n">HttpRequestMessage</span><span class="p">,</span> <span class="n">HttpResponseMessage</span><span class="p">,</span> <span class="n">Task</span><span class="p">&gt;</span> <span class="n">executor</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">var</span> <span class="n">mockItem</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MockItem</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">mockItem</span><span class="p">.</span><span class="n">Executor</span> <span class="p">=</span> <span class="n">executor</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mockItem</span><span class="p">.</span><span class="n">RouteSelector</span> <span class="p">=</span> <span class="n">routeSelector</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">services</span><span class="p">.</span><span class="n">AddTransient</span><span class="p">&lt;</span><span class="n">MockItem</span><span class="p">&gt;(</span><span class="n">sp</span> <span class="p">=&gt;</span> <span class="n">mockItem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">HttpRequestMessage</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span> <span class="n">BuildRouteSelector</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="kt">string</span> <span class="n">url</span><span class="p">,</span> <span class="n">HttpMethod</span> <span class="n">method</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Func</span><span class="p">&lt;</span><span class="n">HttpRequestMessage</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span> <span class="n">selector</span> <span class="p">=</span> <span class="n">request</span> <span class="p">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">url</span> <span class="p">==</span> <span class="s">&#34;*&#34;</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">url</span><span class="p">.</span><span class="n">ToLower</span><span class="p">()</span> <span class="p">==</span> <span class="n">res</span><span class="p">.</span><span class="n">RequestUri</span><span class="p">.</span><span class="n">AbsolutePath</span><span class="p">.</span><span class="n">ToLower</span><span class="p">()</span> <span class="p">&amp;&amp;</span> <span class="n">method</span> <span class="p">==</span> <span class="n">res</span><span class="p">.</span><span class="n">Method</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">selector</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">HttpRequestMessage</span><span class="p">,</span> <span class="n">HttpResponseMessage</span><span class="p">,</span> <span class="n">Task</span><span class="p">&gt;</span> <span class="n">BuildExecutor</span><span class="p">&lt;</span><span class="n">TReturn</span><span class="p">&gt;(</span><span class="n">TReturn</span> <span class="n">@return</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Func</span><span class="p">&lt;</span><span class="n">HttpRequestMessage</span><span class="p">,</span> <span class="n">HttpResponseMessage</span><span class="p">,</span> <span class="n">Task</span><span class="p">&gt;</span> <span class="n">executor</span> <span class="p">=</span> <span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span> <span class="p">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span><span class="p">.</span><span class="n">StatusCode</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">Net</span><span class="p">.</span><span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">@return</span> <span class="k">is</span> <span class="n">HttpStatusCode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">response</span><span class="p">.</span><span class="n">StatusCode</span> <span class="p">=</span> <span class="p">(</span><span class="n">HttpStatusCode</span><span class="p">)</span><span class="n">Enum</span><span class="p">.</span><span class="n">Parse</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="k">typeof</span><span class="p">(</span><span class="n">HttpStatusCode</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="n">@return</span><span class="p">.</span><span class="n">ToString</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">@return</span> <span class="k">is</span> <span class="n">Exception</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="n">@return</span> <span class="k">as</span> <span class="n">Exception</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">@return</span> <span class="k">is</span> <span class="kt">string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">response</span><span class="p">.</span><span class="n">Content</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StringContent</span><span class="p">(</span><span class="n">@return</span> <span class="k">as</span> <span class="kt">string</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="n">response</span><span class="p">.</span><span class="n">Content</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StringContent</span><span class="p">(</span><span class="n">@return</span> <span class="p">==</span> <span class="kc">null</span> <span class="p">?</span> 
</span></span><span class="line"><span class="cl">                <span class="s">&#34;&#34;</span> <span class="p">:</span> <span class="n">JsonConvert</span><span class="p">.</span><span class="n">SerializeObject</span><span class="p">(</span><span class="n">@return</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">executor</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>此时，我们就可以在单元测试中对接口进行模拟，这样就实现了真正意义上的单元测试：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">services</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ServiceCollection</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 添加 HttpClient并注册ApiMockHttpMessageHandler</span>
</span></span><span class="line"><span class="cl"><span class="n">services</span><span class="p">.</span><span class="n">AddHttpClient</span><span class="p">(</span><span class="s">&#34;ApiMock&#34;</span><span class="p">,</span> <span class="n">options</span> <span class="p">=&gt;</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">  <span class="n">options</span><span class="p">.</span><span class="n">BaseAddress</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Uri</span><span class="p">(</span><span class="s">&#34;https://blog.yuanpei.me&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">AddHttpMessageHandler</span><span class="p">&lt;</span><span class="n">ApiMockHttpMessageHandler</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 添加3个模拟接口</span>
</span></span><span class="line"><span class="cl"><span class="n">services</span><span class="p">.</span><span class="n">AddMock</span><span class="p">(</span><span class="s">&#34;/api/status&#34;</span><span class="p">,</span> <span class="n">HttpMethod</span><span class="p">.</span><span class="n">Get</span><span class="p">,</span> <span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">OK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">services</span><span class="p">.</span><span class="n">AddMock</span><span class="p">(</span><span class="s">&#34;/api/query&#34;</span><span class="p">,</span> <span class="n">HttpMethod</span><span class="p">.</span><span class="n">Post</span><span class="p">,</span> <span class="k">new</span> <span class="n">Exception</span><span class="p">(</span><span class="s">&#34;帅哥你谁啊&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="n">services</span><span class="p">.</span><span class="n">AddMock</span><span class="p">(</span><span class="s">&#34;/api/order&#34;</span><span class="p">,</span> <span class="n">HttpMethod</span><span class="p">.</span><span class="n">Get</span><span class="p">,</span> <span class="k">new</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">  <span class="n">OrderId</span> <span class="p">=</span> <span class="s">&#34;OR09874&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="n">CreatedBy</span> <span class="p">=</span> <span class="s">&#34;张三&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">serviceProvider</span> <span class="p">=</span> <span class="n">services</span><span class="p">.</span><span class="n">BuildServiceProvider</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">httpClientFactory</span> <span class="p">=</span> <span class="n">serviceProvider</span><span class="p">.</span><span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">IHttpClientFactory</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">httpClient</span> <span class="p">=</span> <span class="n">httpClientFactory</span><span class="p">.</span><span class="n">CreateClient</span><span class="p">(</span><span class="s">&#34;ApiMock&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 调用/api/order接口</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="k">await</span> <span class="n">httpClient</span><span class="p">.</span><span class="n">GetAsync</span><span class="p">(</span><span class="s">&#34;/api/order&#34;</span><span class="p">);</span>
</span></span></code></pre></div><p>下图是模拟接口返回的结果，与我们期望的完全一致：</p>
<p><img src="https://i.loli.net/2021/04/30/k9lX12aSpcr8ReV.png" alt="HttpMessageHandler 实现接口模拟"></p>
<h1 id="本文小结">本文小结</h1>
<p>古人云：<strong>他山之石，可以攻玉</strong>。原本被接口模拟(<strong>Mock</strong>)所吸引的博主，意外地收获了 <code>HttpMessageHandler</code> 这个令人兴奋的知识点。博主认为，它是一种可以对 请求消息(<strong>HttpRequestMessage</strong>) 和 响应消息(<strong>HttpResponseMessage</strong>) 进行处理，同时多个 <code>HttpMessageHandler</code> 可以组成一个完整的消息处理通道的中间件。在此基础上，我们实现了诸如<strong>日志记录</strong>、<strong>请求重试</strong>、<strong>接口模拟</strong>等等的扩展性功能。除此以外，它还可以应用到 <strong>Http认证头处理</strong> 、<strong>客户端负载均衡</strong>等方面。</p>
<p>其实，从 ASP.NET、OWIN、Nancy、ASP.NET Core 这样一路走过来，你会发现，管道的概念一直都存在，无非是以不同的形式存在着，譬如 ASP.NET Core 里的中间件，其实是替代了曾经的 <code>HttpHandler</code> 和 <code>HttpModule</code>，就像时间一直都在那里，不快不慢，觉得物是人非、喜新厌旧的多半还是我们。对我而言，写到这里，最大的感慨或许是，曾经试图实现的类似 <code>Servlet</code> 的 Http Server ，现在想起来还是太年轻、太朴实了，可年轻或者朴实，难道不好吗？好了，以上就是这篇博客的全部内容了，如果你觉得这篇博客对你有所帮助或者启发，希望你可以毫不吝啬地给个一键三连。如果你对这篇博客里的内容有意见或者建议，欢迎你评论区留下你的足迹和声音，谢谢大家！</p>

            </div>

            
            
            
<div class="copyright s-card">
  <div class="title">
    <span class="post-name">使用 HttpMessageHandler 实现 HttpClient 请求管道自定义</span>
    
    <a :href="http://localhost:1313/posts/2070070822/" class="post-link" target="_blank">
      http://localhost:1313/posts/2070070822/
    </a>
    
  </div>
  <div class="post-meta">
    <div class="meta-item">
      <span class="tip">作者</span>
      <span class="name">飞鸿踏雪</span>
    </div>
    
    <div class="meta-item">
      <span class="tip">发布于</span>
      <span class="name">2021-04-28</span>
    </div>
    
    
    <div class="meta-item">
      <span class="tip">更新于</span>
      <span class="name">2021-04-28</span>
    </div>
    
    
    <div class="meta-item cc">
      <span class="tip">许可协议</span>
      <a class="name" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans" target="_blank">
        CC BY-NC-SA 4.0
      </a>
    </div>
    
  </div>
  <span class="meta-tip">署名-非商业性使用-相同方式共享 4.0 国际</span>
</div>

            

            
            <div class="other-meta">
                <div class="all-tags">
                    
                    
                    <a href="/tags/httpclient" class="tag-item">
                        <i class="iconfont icon-hashtag"></i>
                        <span class="name">HttpClient</span>
                    </a>
                    
                    <a href="/tags/mock" class="tag-item">
                        <i class="iconfont icon-hashtag"></i>
                        <span class="name">Mock</span>
                    </a>
                    
                    <a href="/tags/%E7%AE%A1%E9%81%93" class="tag-item">
                        <i class="iconfont icon-hashtag"></i>
                        <span class="name">管道</span>
                    </a>
                    
                    <a href="/tags/%E6%89%A9%E5%B1%95" class="tag-item">
                        <i class="iconfont icon-hashtag"></i>
                        <span class="name">扩展</span>
                    </a>
                    
                    
                </div>
                <a href="https://eqnxweimkr5.feishu.cn/share/base/form/shrcnCXCPmxCKKJYI3RKUfefJre" 
                   class="report" 
                   target="_blank">
                    <i class="iconfont icon-report"></i>
                    反馈与投诉
                </a>
            </div>

            
            
<div class="reward">
  <div class="reward-btn" onclick="document.getElementById('rewardModal').style.display='block'">
    <i class="iconfont icon-reward"></i>
    <span class="text">赞赏博主</span>
  </div>

  
  <div id="rewardModal" class="modal" style="display: none;">
    <div class="modal-mask" onclick="document.getElementById('rewardModal').style.display='none'"></div>
    <div class="modal-container">
      <div class="modal-header">
        <span class="modal-title">
          <i class="iconfont icon-reward"></i>
          赞赏博主
        </span>
        <span class="modal-close" onclick="document.getElementById('rewardModal').style.display='none'">
          <i class="iconfont icon-close"></i>
        </span>
      </div>
      
      <div class="modal-content">
        <div class="reward-card">
          <span class="thank">🙏 感谢您赐予我前进的力量</span>
          <div class="qr">
            
            <a href="/images/reward/wechat.jpg" class="qr-img" target="_blank">
              <img src="/images/reward/wechat.jpg" alt="微信" />
              <span class="tip">
                <i class="iconfont icon-wechat-pay"></i>
                微信
              </span>
            </a>
            
            
            
            <a href="/images/reward/alipay.jpg" class="qr-img" target="_blank">
              <img src="/images/reward/alipay.jpg" alt="支付宝" />
              <span class="tip">
                <i class="iconfont icon-alipay"></i>
                支付宝
              </span>
            </a>
            
          </div>
          
          <div class="all-list s-card hover">
            <span class="title">全部赞赏者名单</span>
            <span class="tip">赞赏金额将全部用于开源项目维护，以及服务器、域名及各类云服务的开销</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 1000;
}

.modal-mask {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1001;
}

.modal-container {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  max-width: 430px;
  width: 90%;
  background: var(--main-card-background);
  border-radius: 8px;
  padding: 20px;
  z-index: 1002;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.modal-close {
  cursor: pointer;
}

 
.reward {
  position: relative;
  display: flex;
  justify-content: center;
  width: max-content;
  margin: 1rem auto;
  user-select: none;
}

.reward-btn {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: center;
  height: 40px;
  width: 120px;
  border-radius: 8px;
  color: #fff;
  background-color: var(--main-color-red);
  transition: box-shadow 0.5s;
  cursor: pointer;
}

 
</style>



            
            

            
            
  
  
  
  
  <div class="related-post">
    <div class="title">
      <span class="name">
        <i class="iconfont icon-star"></i>
        相关推荐
      </span>
      
      <span class="shuffle" onclick="window.location.href='\/posts\/3599307336\/'">
        随便逛逛
      </span>
      
    </div>

    
    



<div class="post-list ">
    
    <article class="post-item s-card">
        
        
        
        <div class="content">
            
            <h2 class="title">
                <a href="/posts/semantic-kernel-mcp-agent-context-enhanced-exploration/">Semantic Kernel × MCP：智能体的上下文增强探索</a>
            </h2>
            
            
            <div class="summary">
                
                    本文深入探讨了 MCP（模型上下文协议），由 Anthropic 设计的开放协议，它如同 AI 领域的 USB 接口，旨在通过统一接口解决大模型连接不同数据源和工具的问题。文章详细介绍了 MCP 的架构、核心角色、工作原理以及如何与 Semantic Kernel 集成，为 .NET 开发者提供高效接入社区 MCP 服务器的方法，减少重复性平台对接工作。此外，还展示了 MCP 在操作浏览器、访问文件系统等场景中的应用效果，并探讨了其局限性及未来发展方向。在 AI 技术快速发展的背景下，MCP 的出现为实现 AI 模型的 “万物互联” 提供了可能，值得开发者关注与探索。
                
            </div>
            
            
            <div class="meta">
                
                <div class="date">
                    <i class="iconfont icon-calendar"></i>
                    <span>2025-03-09</span>
                </div>
                
                
                
                <div class="categories">
                    <i class="iconfont icon-folder"></i>
                    
                    <a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80">编程语言</a>
                    
                </div>
                
                
                
                
                <div class="tags">
                    <i class="iconfont icon-tag"></i>
                    
                    <a href="/tags/mcp">MCP</a>
                    
                    <a href="/tags/agent">Agent</a>
                    
                    <a href="/tags/semantic-kernel">Semantic Kernel</a>
                    
                    <a href="/tags/function-calling">Function Calling</a>
                    
                </div>
                
            </div>
        </div>
    </article>
    
    <article class="post-item s-card">
        
        
        
        <div class="content">
            
            <h2 class="title">
                <a href="/posts/face-photo-fast-classification-using-k-means-clustering/">基于 K-Means 聚类分析实现人脸照片的快速分类</a>
            </h2>
            
            
            <div class="summary">
                
                    本文介绍了使用 K-Means 聚类算法对人脸照片进行自动分类的方法，解决了 “脸盲症” 问题。通过 Dlib 提取人脸特征向量，并利用 Scikit-Learn 的 K-Means 聚类分析，能够快速将大量人脸照片按人物进行分类。文章详细讲解了 K-Means 算法的原理、K 值确定方法，以及如何使用 PCA 降维和 Matplotlib 可视化聚类结果。该技术方案帮助用户高效地整理和管理照片，避免了人工分类的繁琐过程。尽管 K-Means 算法简单高效，但其对簇数和初始中心的选择较为敏感，可能不适用于噪声数据和非凸形簇，建议在实际应用中结合 DBSCAN 等算法以提高聚类效果。
                
            </div>
            
            
            <div class="meta">
                
                <div class="date">
                    <i class="iconfont icon-calendar"></i>
                    <span>2025-01-14</span>
                </div>
                
                
                
                <div class="categories">
                    <i class="iconfont icon-folder"></i>
                    
                    <a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80">编程语言</a>
                    
                </div>
                
                
                
                
                <div class="tags">
                    <i class="iconfont icon-tag"></i>
                    
                    <a href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0">机器学习</a>
                    
                    <a href="/tags/%E4%BA%BA%E8%84%B8%E5%88%86%E7%B1%BB">人脸分类</a>
                    
                    <a href="/tags/k-means">K-Means</a>
                    
                    <a href="/tags/scikit-learn">Scikit-Learn</a>
                    
                    <a href="/tags/%E8%81%9A%E7%B1%BB">聚类</a>
                    
                </div>
                
            </div>
        </div>
    </article>
    
</div> 
  </div>
  


<style>
.related-post {
  margin-top: 1rem;
}

.related-post .title {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: space-between;
  width: 100%;
  margin: 3rem 0 1rem 0;
  padding: 0 6px;
}

.related-post .title .name {
  display: flex;
  align-items: center;
  font-size: 24px;
  font-weight: bold;
}

.related-post .title .name .iconfont {
  font-size: 26px;
  font-weight: normal;
  margin-right: 8px;
}

.related-post .title .shuffle {
  opacity: 0.6;
  font-size: 14px;
  transition: color 0.3s, opacity 0.3s;
  cursor: pointer;
}

.related-post .title .shuffle:hover {
  opacity: 1;
  color: var(--main-color);
}
</style>


            
            <div id="comments">
                
<div id="main-comment" class="comment">
    <div v-if="!fill" class="title">
        <span class="name">
            <i class="iconfont icon-chat"></i>
            评论
        </span>
        <span class="tool"> 隐私政策 </span>
    </div>
    <link rel="stylesheet" href="https://unpkg.com/@waline/client@v3/dist/waline.css"/>
<div id="waline" class="waline-container"></div>
<style>
    .waline-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
    .waline-container .vcount {
        color: var(--card-text-color-main);
    }
</style>


    <script type="module">
        import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js';
        init({
            el: '#waline',
            serverURL: 'https:\/\/waline.yuanpei.me\/',
            lang: 'zh',
            dark: 'auto',
            path: window.location.href,
            requiredMeta: ['nick','mail'],
            emoji: [
                '//unpkg.com/@waline/emojis@1.2.0/weibo'
            ],
            reaction: false,
        });
      </script>


</div>

            </div>
        </article>
        
        <aside class="main-aside"><div class="sticky"> 
<div class="aside-countdown s-card weidgets">
  <div class="card-title">
    <i class="fas fa-hourglass-half"></i>
    <span>倒计时</span>
  </div>
  <div class="card-content">
    
  </div>
</div> 
<div class="tags-cloud s-card weidgets">
  <div class="title">
    <i class="iconfont icon-hashtag"></i>
    <span class="title-name">热门标签</span>
  </div>
  <div class="all-tags">
    
  </div>
  <a href="/pages/tags" class="more-tags">查看全部</a>
</div><div class="site-data s-card weidgets">
    <div class="title">
      <i class="iconfont icon-chart"></i>
      <span class="title-name">站点数据</span>
    </div>
    <div class="all-data">
      <div class="data-item">
        <span class="name">
          <i class="iconfont icon-article"></i>
          文章总数
        </span>
        <span class="num">277 篇</span>
      </div>
      <div class="data-item">
        <span class="name">
          <i class="iconfont icon-date"></i>
          建站天数
        </span>
        <span class="num">200 天</span>
      </div>
      <div class="data-item">
        <span class="name">
          <i class="iconfont icon-visibility"></i>
          总访问量
        </span>
        <span class="num" id="busuanzi_value_site_pv">0</span>
      </div>
      <div class="data-item">
        <span class="name">
          <i class="iconfont icon-account"></i>
          总访客数
        </span>
        <span class="num" id="busuanzi_value_site_uv">0</span>
      </div>
    </div>
  </div></div>
  </aside>
  <style>
  .main-aside {
    padding-left: 1rem;
    display: flex;
    flex-direction: column;
    animation: fade-up 0.6s 0.3s backwards;
    .weidgets {
      padding: 18px;
      margin-bottom: 1rem;
      :deep(.title) {
        margin-bottom: 12px;
        font-weight: bold;
        display: flex;
        align-items: center;
        opacity: 0.75;
        .iconfont {
          opacity: 0.6;
          margin-right: 6px;
        }
        .title-name {
          opacity: 0.8;
        }
      }
    }
    .sticky {
      position: sticky;
      top: calc(60px + 1rem);
      .weidgets {
        animation: fade-up 0.6s 0.4s backwards;
        &:last-child {
          margin-bottom: 0;
        }
      }
    }
  }
  </style>
  
    </div>
</div>

        </main>

        <div class="footer-link">
    
    <div class="footer-bar">
      <span class="site-title">元视角</span>
      <span class="site-desc">纵有疾风起，人生不言弃</span>
      <a href="/" class="to-home">了解更多</a>
    </div>
    
  
    <div class="footer-social">
      
      <a href="https://github.com/yourusername" target="_blank" class="social-link">
        <i class="iconfont icon-github"></i>
      </a>
      
      <a href="https://twitter.com/yourusername" target="_blank" class="social-link">
        <i class="iconfont icon-weibo"></i>
      </a>
      
  
      <div class="logo" title="返回顶部" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
        <img src="/images/icons8-stellar-128.png" alt="author" class="author" />
      </div>
  
      
      <a href="mailto:qinyuanpei@163.com" target="_blank" class="social-link">
        <i class="iconfont icon-email"></i>
      </a>
      
      <a href="https://space.bilibili.com/yourid" target="_blank" class="social-link">
        <i class="iconfont icon-douban"></i>
      </a>
      
    </div>
  
    <div class="footer-sitemap">
      
      <div class="sitemap-item">
        <span class="title">博客</span>
        <div class="links">
          
          <a href="/posts"  class="link-text">
            近期文章
          </a>
          
          <a href="/categories"  class="link-text">
            全部分类
          </a>
          
          <a href="/tags"  class="link-text">
            全部标签
          </a>
          
          <a href="/archives"  class="link-text">
            文章归档
          </a>
          
        </div>
      </div>
      
      <div class="sitemap-item">
        <span class="title">项目</span>
        <div class="links">
          
          <a href="https://example1.com" target="_blank" class="link-text">
            项目1
          </a>
          
          <a href="https://example2.com" target="_blank" class="link-text">
            项目2
          </a>
          
          <a href="https://example2.com" target="_blank" class="link-text">
            项目3
          </a>
          
          <a href="https://example2.com" target="_blank" class="link-text">
            项目4
          </a>
          
        </div>
      </div>
      
      <div class="sitemap-item">
        <span class="title">专栏</span>
        <div class="links">
          
          <a href="https://blog.csdn.net/qinyuanpei/category_10852603.html" target="_blank" class="link-text">
            .NET 源代码探案系列
          </a>
          
          <a href="https://blog.csdn.net/qinyuanpei/category_7444699.html" target="_blank" class="link-text">
            Python 数据挖掘系列
          </a>
          
          <a href="https://blog.csdn.net/qinyuanpei/category_11484903.html" target="_blank" class="link-text">
            分布式丛林探险系列
          </a>
          
          <a href="https://blog.csdn.net/qinyuanpei/category_1708629.html" target="_blank" class="link-text">
            Unity3D 游戏开发系列
          </a>
          
        </div>
      </div>
      
      <div class="sitemap-item">
        <span class="title">页面</span>
        <div class="links">
          
          <a href="/guest"  class="link-text">
            畅所欲言
          </a>
          
          <a href="/books"  class="link-text">
            阅读记录
          </a>
          
          <a href="/movies"  class="link-text">
            观影记录
          </a>
          
          <a href="/musics"  class="link-text">
            听歌记录
          </a>
          
        </div>
      </div>
      
      <div class="sitemap-item">
        <span class="title">友情链接</span>
        <div class="links">
          
          <a href="https://blog.zhheo.com/"  class="link-text">
            张洪
          </a>
          
          <a href="https://blog.zhheo.com/"  class="link-text">
            张洪
          </a>
          
          <a href="https://blog.zhheo.com/"  class="link-text">
            张洪
          </a>
          
          <a href="https://blog.zhheo.com/"  class="link-text">
            更多
          </a>
          
        </div>
      </div>
      
    </div>
  </div><footer id="main-footer" class="main-footer">
    <div class="footer-content">
        <div class="footer-copyright">
            <span class="time" data-v-6001e979="">@ 2014 - 2025 By </span>
            <a href="https://www.imsyy.top" class="author link" target="_blank">
                飞鸿踏雪
            </a>
            
            
        </div>
        <div class="meta">
            <a class="power link" href="https://vitepress.dev/" target="_blank">
                <span class="by">Powered by</span>
                <span class="name">Hugo</span>
            </a>
            <a class="theme link" href="/pages/theme">
                <span class="name">主题</span>
            </a>
            <a class="rss link" href="https://blog.imsyy.top/rss.xml" target="_blank">
                <i class="iconfont icon-rss"></i>
                <span class="name" data-v-6001e979="">订阅</span>
            </a>
            <a class="cc link" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans" target="_blank">
                <i class="iconfont icon-line"></i>
                <i class="iconfont icon-by-line"></i>
                <i class="iconfont icon-nc-line"></i><i
                    class="iconfont icon-nd-line"></i>
            </a>
        </div>
    </div>
</footer>

<script src="/js/search.min.f2af2dfa3be20e8e7e8c8989bab508289b71bf3730bc6e352738f2084973a1ab.js"></script>
<script>
    
    document.addEventListener('DOMContentLoaded', () => {
        Search.init();
    });
</script>

<script src="/js/theme.min.df71ca7373c5884a4022a354b524ddee31ff8069b6ff5151b5950296b2d3a7a8.js"></script><div class="modal search-modal" id="searchModal">
  <div class="modal-container">
    <div class="modal-header">
      <div class="modal-title">
        <i class="iconfont icon-search"></i>
        <span>全局搜索</span>
      </div>
      <div class="modal-close">
        <i class="iconfont icon-close"></i>
      </div>
    </div>

    <div class="search-container">
      <div class="search-box">
        <input 
          type="text" 
          id="searchInput"
          placeholder="想要搜点什么" 
          autocomplete="off"
          autofocus
        >
      </div>

      <div class="search-results" id="searchResults">
        <div class="no-result" id="noResult" style="display: none;">
          <i class="iconfont icon-search-empty"></i>
          <span class="text">搜索结果为空</span>
        </div>
        <div class="search-list" id="searchList"></div>
      </div>

      <div class="search-stats">
        <span class="text" id="searchStats"></span>
      </div>
    </div>
  </div>
</div>

<style>
.search-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 999;
  display: none;
}

.modal-container {
  position: relative;
  width: 90%;
  max-width: 768px;
  margin: 80px auto;
  background-color: var(--main-card-background);
  border-radius: 12px;
  padding: 1.5rem;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.modal-title {
  display: flex;
  align-items: center;
  font-size: 1.2rem;
  font-weight: bold;
}

.modal-title .iconfont {
  margin-right: 0.5rem;
}

.modal-close {
  cursor: pointer;
  padding: 0.5rem;
}

.search-box input {
  width: 100%;
  outline: none;
  border-radius: 8px;
  font-size: 16px;
  padding: 0.6rem 1rem;
  color: var(--main-font-color);
  font-family: var(--main-font-family);
  border: 1px solid var(--main-card-border);
  background-color: var(--main-card-second-background);
  transition: border-color 0.3s, box-shadow 0.3s;
}

.search-box input:focus {
  border-color: var(--main-color);
  box-shadow: 0 8px 16px -4px var(--main-color-bg);
}

.search-results {
  margin-top: 20px;
  min-height: 300px;
}

.no-result {
  height: 300px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.no-result .iconfont {
  font-size: 40px;
  margin-bottom: 12px;
}

.no-result .text {
  font-size: 18px;
  opacity: 0.6;
}

.search-list .search-item {
  margin-bottom: 12px;
  padding: 1rem;
  border-radius: 8px;
  background-color: var(--main-card-second-background);
  cursor: pointer;
  transition: transform 0.3s;
}

.search-list .search-item:hover {
  transform: translateY(-2px);
}

.search-item .title {
  font-size: 16px;
  margin-bottom: 6px;
}

.search-item .content {
  color: var(--main-font-second-color);
  font-size: 14px;
  margin-top: 8px;
}

.search-stats {
  margin-top: 1rem;
  font-size: 14px;
  color: var(--main-font-second-color);
}

.highlight {
  color: var(--main-color);
  background: transparent;
}
</style> 

        
    </body>
</html> 